<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ata Operacional Porter - 2026</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
    --primary: #1a3a5f;
    --accent: #e67e22;
    --bg: #f0f2f5;
    --white: #ffffff;
    --danger: #e74c3c;
    --success: #27ae60;
    --warning: #f39c12;
    --info: #3498db;
    --gray: #7f8c8d;
    --sidebar-width: 280px;
    --header-height: 70px;
}

* {
    box-sizing: border-box;
    font-family: 'Segoe UI', Roboto, sans-serif;
    margin: 0;
    padding: 0;
}

body {
    background: var(--bg);
    color: #333;
    min-height: 100vh;
    display: flex;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 30px white inset !important;
    box-shadow: 0 0 0 30px white inset !important;
    -webkit-text-fill-color: #333 !important;
}

/* SIDEBAR */
#sidebar {
    width: var(--sidebar-width);
    background: white;
    border-right: 1px solid #e0e0e0;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    overflow-y: auto;
    box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    z-index: 99;
    transition: transform 0.3s ease;
    transform: translateX(-100%);
    display: none;
}

@media (min-width: 1200px) {
    #sidebar {
        transform: translateX(0);
        display: block;
    }
    #main-content {
        margin-left: var(--sidebar-width);
    }
}

#sidebar.show {
    transform: translateX(0);
    display: block;
}

.sidebar-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary) 0%, #2c3e50 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.sidebar-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
}

.sidebar-toggle {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: none;
}

@media (max-width: 1200px) {
    .sidebar-toggle {
        display: block;
    }
}

.condo-list {
    padding: 1rem 0;
}

.condo-item {
    padding: 0.9rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 3px solid transparent;
}

.condo-item:hover {
    background: #f8f9fa;
}

.condo-item.active {
    background: #e8f4fc;
    border-left-color: var(--accent);
    font-weight: 600;
    color: var(--primary);
}

.condo-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.condo-badge {
    background: var(--danger);
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    display: none;
}

.condo-badge.has-notification {
    display: block;
    animation: pulse 2s infinite;
}

/* CONTE√öDO PRINCIPAL */
#main-content {
    flex: 1;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: margin-left 0.3s ease;
}

@media (max-width: 1200px) {
    #main-content {
        margin-left: 0;
    }
}

/* HEADER */
header {
    background: linear-gradient(135deg, var(--primary) 0%, #2c3e50 100%);
    color: white;
    padding: 0.8rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: var(--header-height);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.mobile-toggle {
    display: none;
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2rem;
}

@media (max-width: 768px) {
    .mobile-toggle {
        display: block;
    }
}

.header-logo {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* LOGO SEM FUNDO */
.logo-porter {
    width: 160px;
    height: 40px;
    background-image: url('https://managing-azure-iu7mo6meja.edgeone.dev/Porter_Horizontal_Preto__1__page-0001-removebg-preview.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    padding: 5px 10px;
    border-radius: 6px;
}

.header-logo-text {
    display: flex;
    flex-direction: column;
}

.header-logo-text strong {
    font-size: 1.2rem;
}

.header-logo-text div {
    font-size: 0.75rem;
    opacity: 0.9;
}

/* OPERADORES ONLINE - CORRIGIDO */
.online-users-dropdown {
    cursor: pointer;
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
    position: relative;
}

.online-users-dropdown:hover {
    background: rgba(255,255,255,0.2);
}

.online-users-list {
    position: absolute;
    top: 100%;
    right: 0;
    width: 280px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 5px;
    display: none;
    padding: 0;
}

.online-user-item {
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
    cursor: default;
}

.online-user-item:last-child {
    border-bottom: none;
}

.online-user-item:hover {
    background: #f8f9fa;
}

.online-user-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    background: #e8f4fc;
    color: var(--primary);
    flex-shrink: 0;
}

.online-user-info {
    flex: 1;
    min-width: 0;
}

.online-user-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.online-user-role {
    font-size: 0.75rem;
    color: #666;
    margin-top: 2px;
}

.online-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #2ecc71;
    animation: pulse 2s infinite;
    flex-shrink: 0;
}

/* √ÅREA DE INFORMA√á√ïES DO USU√ÅRIO */
#user-info {
    background: rgba(255,255,255,0.1);
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    font-size: 0.9rem;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 220px;
}

@media (max-width: 768px) {
    #user-info {
        min-width: auto;
        width: 100%;
        text-align: center;
        margin-top: 10px;
    }
}

.user-info-name {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.user-info-time {
    font-size: 0.8rem;
    opacity: 0.9;
    display: flex;
    align-items: center;
    gap: 6px;
}

.user-info-role {
    font-size: 0.75rem;
    opacity: 0.8;
    background: rgba(255,255,255,0.15);
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 2px;
}

/* NOTIFICA√á√ïES */
.notification-bell {
    position: relative;
    cursor: pointer;
    font-size: 1.3rem;
    color: white;
    padding: 8px;
    border-radius: 6px;
    background: rgba(255,255,255,0.1);
}

/* FIX: altera√ß√£o da cor da notifica√ß√£o para azul escuro */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #0a1e3f; /* azul escuro elegante - AJUSTADO */
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    animation: pulse 2s infinite;
}

.notifications-panel {
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    max-height: 400px;
    overflow-y: auto;
}

.notifications-panel.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

.notification-header {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 10px 10px 0 0;
    color: #333;
}

.notification-header strong {
    color: var(--primary);
}

.notification-item {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
    background: white;
    color: #333;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item.unread {
    background: #e8f4fc !important;
    border-left: 4px solid var(--info);
    color: #333;
}

.notification-item.destaque {
    background: #e8f4fc !important;
    border-left: 4px solid #3498db;
    color: #333;
}

.notification-condo {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 5px;
    font-size: 0.95rem;
}

.notification-time {
    font-size: 0.8rem;
    color: var(--gray);
}

/* TABS */
.tabs {
    display: flex;
    background: white;
    padding: 0 2rem;
    gap: 0.5rem;
    border-bottom: 2px solid #e0e0e0;
    overflow-x: auto;
    white-space: nowrap;
}

@media (max-width: 768px) {
    .tabs {
        padding: 0 1rem;
    }
}

.tab-btn {
    padding: 1rem 1.8rem;
    border: none;
    background: none;
    cursor: pointer;
    font-weight: 600;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

@media (max-width: 768px) {
    .tab-btn {
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
    }
}

.tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
    background-color: rgba(230, 126, 34, 0.05);
}

.tab-btn:hover:not(.active) {
    background-color: rgba(0,0,0,0.03);
}

.tab-badge {
    background: var(--accent);
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
}

.chat-badge {
    background: var(--info);
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
    min-width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* CONTAINER PRINCIPAL */
.container {
    flex: 1;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
}

@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
}

/* COMPONENTE DE HUMOR */
.mood-check-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-left: 4px solid var(--accent);
    border-right: 4px solid var(--accent);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.mood-check-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #e74c3c, #e67e22, #f1c40f, #2ecc71, #27ae60);
}

.mood-title {
    color: var(--primary);
    font-size: 1.2rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.mood-subtitle {
    color: var(--gray);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    font-style: italic;
}

.mood-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 1.5rem 0;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .mood-options {
        gap: 10px;
    }
}

.mood-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 12px;
    border-radius: 12px;
    min-width: 90px;
    background: rgba(255,255,255,0.8);
    border: 2px solid transparent;
}

@media (max-width: 768px) {
    .mood-option {
        min-width: 75px;
        padding: 8px;
    }
}

.mood-option:hover {
    background: white;
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.mood-option.selected {
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transform: scale(1.05);
    border-color: currentColor;
}

.mood-face {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    position: relative;
    background: white;
    transition: all 0.3s;
}

@media (max-width: 768px) {
    .mood-face {
        width: 65px;
        height: 65px;
    }
}

.mood-option.selected .mood-face {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.mood-face svg {
    width: 45px;
    height: 45px;
}

@media (max-width: 768px) {
    .mood-face svg {
        width: 35px;
        height: 35px;
    }
}

.mood-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: #333;
    margin-top: 5px;
    text-align: center;
    min-height: 40px;
    display: flex;
    align-items: center;
}

@media (max-width: 768px) {
    .mood-label {
        font-size: 0.8rem;
        min-height: 35px;
    }
}

.mood-description {
    font-size: 0.8rem;
    color: var(--gray);
    margin-top: 5px;
    font-style: italic;
    min-height: 20px;
}

.mood-status {
    font-size: 1rem;
    color: var(--primary);
    font-weight: 600;
    margin-top: 10px;
    min-height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.mood-submit {
    margin-top: 1.5rem;
}

.mood-result {
    background: white;
    padding: 1.2rem;
    border-radius: 8px;
    margin-top: 1rem;
    border: 2px solid var(--success);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    animation: fadeIn 0.5s ease-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.mood-result i {
    color: var(--success);
    font-size: 1.3rem;
}

/* CHAT GERAL */
.chat-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 500px;
}

@media (max-width: 768px) {
    .chat-container {
        height: 400px;
    }
}

.chat-header {
    background: linear-gradient(135deg, var(--primary) 0%, #2c3e50 100%);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: #f8f9fa;
}

/* FIX: scroll do chat otimizado */
.chat-messages {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

.chat-message {
    max-width: 80%;
    padding: 0.8rem 1rem;
    border-radius: 12px;
    position: relative;
}

@media (max-width: 768px) {
    .chat-message {
        max-width: 90%;
    }
}

.chat-message.sent {
    align-self: flex-end;
    background: var(--info);
    color: white;
    border-bottom-right-radius: 4px;
}

.chat-message.received {
    align-self: flex-start;
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
}

.chat-message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 0.85rem;
}

.chat-message-sender {
    font-weight: 600;
}

.chat-message-time {
    opacity: 0.8;
}

.chat-message-text {
    word-wrap: break-word;
    line-height: 1.4;
}

.chat-input-area {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e0e0e0;
    background: white;
    display: flex;
    gap: 10px;
}

@media (max-width: 768px) {
    .chat-input-area {
        padding: 0.8rem;
    }
}

.chat-input {
    flex: 1;
    padding: 0.8rem 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: none;
    font-size: 0.95rem;
    font-family: inherit;
}

.chat-input:focus {
    outline: none;
    border-color: var(--info);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.chat-admin-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.chat-clear-btn {
    background: var(--danger);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* FORMUL√ÅRIOS E FILTROS */
.filters-container {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    border-left: 4px solid var(--primary);
}

.filters-title {
    color: var(--primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
}

.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

@media (max-width: 768px) {
    .grid-2, .grid-3 {
        grid-template-columns: 1fr;
    }
}

.filter-actions {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

@media (max-width: 768px) {
    .filter-actions {
        flex-direction: column;
    }
    .filter-actions .btn {
        width: 100%;
    }
}

.form-group { margin-bottom: 1.4rem; }

label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #444; }

input, select, textarea {
    width: 100%;
    padding: 0.9rem;
    border: 1.5px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
}

.input-icon {
    position: relative;
}

.input-icon i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray);
}

.input-icon input, .input-icon select {
    padding-left: 45px;
}

/* BOT√ïES */
.btn {
    padding: 0.9rem 1.8rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, #2c3e50 100%);
    color: white;
    width: 100%;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(26, 58, 95, 0.4);
}

.btn-accent {
    background: linear-gradient(135deg, var(--accent) 0%, #d35400 100%);
    color: white;
}

.btn-accent:hover {
    background: linear-gradient(135deg, #d35400 0%, var(--accent) 100%);
}

.btn-danger {
    background: var(--danger);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-filter {
    background: var(--primary);
    color: white;
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
}

.btn-filter:hover {
    background: #2c3e50;
    transform: translateY(-2px);
}

.btn-clear {
    background: var(--gray);
    color: white;
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
}

.btn-clear:hover {
    background: #5d6d7e;
}

.btn-success {
    background: var(--success);
    color: white;
    padding: 0.8rem 1.5rem;
}

.btn-success:hover {
    background: #229954;
}

.btn-info {
    background: var(--info);
    color: white;
    padding: 0.8rem 1.5rem;
}

.btn-info:hover {
    background: #2980b9;
}

.btn-warning {
    background: var(--warning);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
}

/* CARDS DE ATA */
.ata-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1.2rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    border-left: 5px solid var(--accent);
    position: relative;
    transition: transform 0.3s, box-shadow 0.3s;
}

.ata-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.ata-card.fixed {
    border-left-color: var(--warning);
    background: linear-gradient(to right, #fff3cd10, white);
}

.ata-card.os {
    border-left-color: var(--info);
    background: linear-gradient(to right, #d6eaf810, white);
}

.ata-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
    font-size: 0.85rem;
    color: var(--gray);
}

.ata-condo {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-finalizado { background: #d4edda; color: #155724; }
.status-andamento { background: #fff3cd; color: #856404; }
.status-fixo { background: #e8f4fc; color: #1a3a5f; }
.status-os { background: #d6eaf8; color: #1b4f72; }

.ata-type {
    display: inline-block;
    padding: 3px 10px;
    background: #e8f4fc;
    color: #1a3a5f;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    margin: 5px 0 10px 0;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.ata-type.fixed {
    background: #fff3cd;
    color: #856404;
}

.ata-type.os {
    background: #d6eaf8;
    color: #1b4f72;
}

/* RESPOSTAS/COMENT√ÅRIOS */
.comment-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.comment-form textarea {
    width: 100%;
    min-height: 100px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    resize: vertical;
    font-family: inherit;
    font-size: 0.95rem;
}

.comment-form textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.1);
}

.comment-form button {
    align-self: flex-end;
}

.comment-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
}

.comment-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 3px solid var(--accent);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.comment-author {
    font-weight: 600;
    color: var(--primary);
}

.comment-time {
    color: var(--gray);
    font-size: 0.8rem;
}

.comment-text {
    white-space: pre-wrap;
    line-height: 1.5;
}

/* FORMUL√ÅRIO OS */
.form-card {
    background: white;
    padding: 1.8rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    border-top: 4px solid var(--accent);
}

.form-card.os-form {
    border-top-color: var(--info);
}

.form-card h2 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ABA DE INFORMA√á√ïES FIXAS */
.fixed-info-container {
    background: #fff3cd20;
    border: 1px solid #fff3cd;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.fixed-info-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
    color: #856404;
}

/* LOGIN SCREEN */
#login-screen {
    min-height: 100vh;
    display: flex !important;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary) 0%, #2c3e50 100%);
    padding: 20px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    transition: opacity 0.3s ease;
}

#login-screen.hidden {
    opacity: 0;
    pointer-events: none;
    z-index: -1;
    display: none !important;
}

.login-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 2.5rem;
    border-radius: 16px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.25);
    width: 100%;
    max-width: 420px;
    border-top: 5px solid var(--accent);
    position: relative;
    overflow: hidden;
}

.login-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--accent), #f39c12);
}

.login-logo {
    text-align: center;
    margin-bottom: 1.5rem;
}

.login-logo h1 {
    color: var(--primary);
    margin: 1rem 0 0.5rem 0;
    font-size: 1.5rem;
}

.login-logo p {
    color: var(--gray);
    font-size: 0.9rem;
}

/* LOGO IMAGEM NO LOGIN - SEM FUNDO */
.login-logo-img {
    width: 180px;
    height: 50px;
    margin: 0 auto 1.2rem;
    background-image: url('https://managing-azure-iu7mo6meja.edgeone.dev/Porter_Horizontal_Preto__1__page-0001-removebg-preview.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}

/* UTILIT√ÅRIOS */
.hidden {
    display: none !important;
}

.visible {
    display: block !important;
}

.fade-in { animation: fadeIn 0.5s ease-out; }

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray);
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.no-results {
    text-align: center;
    padding: 2rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    color: var(--gray);
}

.active-filters {
    background: #e8f4fc;
    padding: 0.8rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--primary);
    border-left: 3px solid var(--accent);
}

.active-filters span {
    background: var(--accent);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-left: 5px;
}

/* ANIMA√á√ïES */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* MODAL */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.modal.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: translateY(-20px);
    transition: transform 0.3s;
}

.modal.show .modal-content {
    transform: translateY(0);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
}

/* CONTROLES ADMIN */
.admin-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.admin-btn {
    background: var(--warning);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.force-logoff-btn {
    background: var(--danger);
}

.force-logoff-btn:hover {
    background: #c0392b;
}

/* TABELAS */
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

table th {
    background: var(--primary);
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
}

table td {
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

table tr:hover {
    background: #f8f9fa;
}

@media (max-width: 768px) {
    table {
        display: block;
        overflow-x: auto;
    }
}

/* BOT√ïES EM GRUPO */
.btn-group {
    display: flex;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #ddd;
}

.btn-group .btn-filter {
    border-radius: 0;
    border-right: 1px solid #ddd;
    margin: 0;
}

.btn-group .btn-filter:last-child {
    border-right: none;
}

/* TOOLTIPS */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #333;
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.85rem;
    font-weight: normal;
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* PDF PREVIEW */
.pdf-preview {
    background: white;
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 2rem;
    margin-top: 1rem;
    text-align: center;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.pdf-icon {
    font-size: 3rem;
    color: var(--danger);
    margin-bottom: 1rem;
}

/* LOADING */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* BOT√ÉO DESABILITADO */
.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* ESTILOS PARA CHAT VISTO POR */
.chat-visto-por {
    transition: all 0.3s ease;
}

.chat-visto-por:hover {
    background: #e8f4fc !important;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ANIMA√á√ÉO PARA NOVAS MENSAGENS */
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-5px);}
    60% {transform: translateY(-3px);}
}

.chat-badge {
    animation: bounce 1s;
    min-width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* ESTILO PARA BADGE VAZIO */
.chat-badge:empty {
    display: none !important;
}

/* ESTILO PARA ABA COM NOVA MENSAGEM */
.chat-tab.has-new-message {
    position: relative;
    animation: pulseTab 2s infinite;
}

.chat-tab.has-new-message::after {
    content: '';
    position: absolute;
    top: 10px;
    right: 10px;
    width: 8px;
    height: 8px;
    background: #e74c3c;
    border-radius: 50%;
    animation: pulseDot 1.5s infinite;
}

@keyframes pulseTab {
    0% { background-color: rgba(52, 152, 219, 0.05); }
    50% { background-color: rgba(52, 152, 219, 0.15); }
    100% { background-color: rgba(52, 152, 219, 0.05); }
}

@keyframes pulseDot {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

/* DESTAQUE PARA MENSAGEM ESPEC√çFICA */
.mensagem-destacada {
    animation: highlightPulse 3s ease-in-out;
    border: 2px solid #e67e22 !important;
    background: #fff9e6 !important;
    position: relative;
}

.mensagem-destacada::before {
    content: 'üîî Nova mensagem';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: #e67e22;
    color: white;
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: bold;
    white-space: nowrap;
}

@keyframes highlightPulse {
    0% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(230, 126, 34, 0); }
    100% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); }
}

/* NOVOS ESTILOS PARA CONFIRMA√á√ÉO DE OS */
.os-confirmation {
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin: 2rem 0;
    animation: fadeIn 0.5s ease-out;
    border-top: 5px solid var(--success);
}

.os-confirmation i {
    font-size: 4rem;
    color: var(--success);
    margin-bottom: 1.5rem;
    animation: pulse 2s infinite;
}

.os-confirmation h2 {
    color: var(--primary);
    margin-bottom: 1rem;
}

.os-confirmation .details {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: left;
    margin: 1.5rem 0;
    border-left: 4px solid var(--info);
}

.os-confirmation .details strong {
    color: var(--primary);
    display: inline-block;
    min-width: 120px;
}

.back-to-os {
    margin-top: 2rem;
}

/* NEW: Estilos para chat privado */
.chat-private-container {
    border: 2px solid #3498db;
    margin-top: 10px;
}

.chat-private-header {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
}

.private-chat-selector {
    margin-bottom: 10px;
}

.private-chat-selector select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ddd;
    font-size: 0.9rem;
}

.chat-private-messages {
    min-height: 200px;
    max-height: 300px;
}

.chat-private-controls {
    display: flex;
    gap: 5px;
}

/* NOVOS ESTILOS PARA STATUS DE OS */
.os-status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin: 5px;
}

.os-status-resolvida { background: #d4edda; color: #155724; }
.os-status-remotamente { background: #d1ecf1; color: #0c5460; }
.os-status-espera { background: #fff3cd; color: #856404; }
.os-status-compareceu { background: #cce5ff; color: #004085; }
.os-status-condominio { background: #f8d7da; color: #721c24; }
.os-status-branco { background: #e2e3e5; color: #383d41; }

/* BOT√ïES DE STATUS */
.status-action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin: 2px;
}

.status-action-btn:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
}

.status-action-btn.tec-only {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
    border-color: #d35400;
}

.status-action-btn.all {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border-color: #2980b9;
}

/* LISTA DE T√âCNICOS */
.tecnicos-container {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    border-left: 4px solid var(--warning);
}
</style>
</head>
<body>

<!-- TELA DE LOGIN -->
<section id="login-screen">
    <div class="login-container">
        <div class="login-logo">
            <!-- LOGO DA PORTER ATUALIZADA SEM FUNDO -->
            <div class="login-logo-img"></div>
            <h1>Ata Operacional Porter</h1>
            <p>Sistema de Registro de Ocorr√™ncias - 2026</p>
        </div>
        <div class="form-group input-icon">
            <i class="fas fa-user"></i>
            <input type="text" id="login-user" placeholder="nome.sobrenome" autocomplete="off">
        </div>
        <div class="form-group input-icon">
            <i class="fas fa-lock"></i>
            <input type="password" id="login-pass" placeholder="********" autocomplete="off">
        </div>
        <div class="form-group input-icon">
            <i class="fas fa-clock"></i>
            <select id="login-turno">
                <option value="Diurno">Diurno</option>
                <option value="Noturno">Noturno</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="app.login()">
            <i class="fas fa-sign-in-alt"></i> ACESSAR SISTEMA
        </button>
        <div style="margin-top: 1.5rem; text-align: center; font-size: 0.8rem; color: var(--gray);">
            <i class="fas fa-info-circle"></i> Use suas credenciais fornecidas pela Porter
        </div>
    </div>
</section>

<!-- SIDEBAR COM LISTA DE CONDOM√çNIOS -->
<div id="sidebar">
    <div class="sidebar-header">
        <h3><i class="fas fa-building"></i> CONDOM√çNIOS</h3>
        <button class="sidebar-toggle" onclick="app.toggleSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="condo-list" id="condo-list">
        <!-- Lista de condom√≠nios ser√° gerada dinamicamente -->
    </div>
</div>

<!-- CONTE√öDO PRINCIPAL -->
<div id="main-content" class="hidden">
    <header>
        <div class="header-left">
            <button class="mobile-toggle" onclick="app.toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="header-logo">
                <!-- LOGO DA PORTER NO HEADER - ATUALIZADA SEM FUNDO -->
                <div class="logo-porter"></div>
                <div class="header-logo-text">
                    <strong>ATA OPERACIONAL PORTER</strong>
                    <div>Sistema de Registro de Ocorr√™ncias - 2026</div>
                </div>
            </div>
        </div>
        <!-- √ÅREA DE INFORMA√á√ïES DO USU√ÅRIO -->
        <div id="user-info">
            <!-- Ser√° preenchido dinamicamente com informa√ß√µes do login -->
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- OPERADORES ONLINE -->
            <div id="online-users" class="online-users-dropdown">
                <i class="fas fa-users" style="color: white;"></i>
                <span style="font-size: 0.9rem;">
                    <span id="online-count">0</span> online
                </span>
                <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                <div id="online-users-list" class="online-users-list"></div>
            </div>
            <!-- Notifica√ß√µes -->
            <div class="notification-bell" onclick="app.toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                <div class="notifications-panel" id="notifications-panel">
                    <div class="notification-header">
                        <strong><i class="fas fa-bell"></i> Notifica√ß√µes</strong>
                        <button class="btn btn-clear btn-sm" onclick="app.clearNotifications()">Limpar</button>
                    </div>
                    <div id="notifications-list"></div>
                </div>
            </div>
            <!-- Bot√£o Relat√≥rio -->
            <button class="btn btn-success" onclick="app.openReportModal()">
                <i class="fas fa-file-pdf"></i> Relat√≥rio
            </button>
            <!-- Bot√£o Admin (apenas para admin) -->
            <div id="admin-controls" class="admin-controls" style="display: none;">
                <button class="btn btn-warning" onclick="app.openAdminPanel()">
                    <i class="fas fa-user-shield"></i> Admin
                </button>
            </div>
            <!-- Bot√£o Sair -->
            <button class="btn btn-accent" onclick="app.logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="app.switchTab('tab-ata', this)">
            <i class="fas fa-file-alt"></i> ATA DE OCORR√äNCIAS
            <span class="tab-badge" id="tab-count-ata">0</span>
        </button>
        <button class="tab-btn" onclick="app.switchTab('tab-fixas', this)">
            <i class="fas fa-thumbtack"></i> INFORMA√á√ïES FIXAS
            <span class="tab-badge" id="tab-count-fixas">0</span>
        </button>
        <button class="tab-btn" onclick="app.switchTab('tab-os', this)">
            <i class="fas fa-tools"></i> ORDEM DE SERVI√áO
            <span class="tab-badge" id="tab-count-os">0</span>
        </button>
        <!-- NOVA ABA: CHAT GERAL -->
        <button class="tab-btn chat-tab" onclick="app.switchTab('tab-chat', this)">
            <i class="fas fa-comments"></i> CHAT GERAL
            <span class="chat-badge" id="chat-badge">0</span>
        </button>
        <!-- NEW: Nova aba de chat privado -->
        <button class="tab-btn" onclick="app.switchTab('tab-chat-privado', this)" id="tab-chat-privado-btn">
            <i class="fas fa-user-secret"></i> CHAT PRIVADO
            <span class="chat-badge" id="chat-private-badge">0</span>
        </button>
        <button class="tab-btn" onclick="app.switchTab('tab-presenca', this)">
            <i class="fas fa-users"></i> HIST√ìRICO
        </button>
    </div>

    <div class="container">
        <!-- Componente de Avalia√ß√£o de Humor -->
        <div id="mood-check-container" class="mood-check-container hidden">
            <div class="mood-title">
                <i class="fas fa-heart"></i> Como voc√™ est√° se sentindo hoje?
            </div>
            <div class="mood-subtitle">
                Selecione a express√£o que melhor representa seu estado emocional atual
            </div>
            <div class="mood-options" id="mood-options">
                <!-- As op√ß√µes ser√£o geradas via JavaScript -->
            </div>
            <div class="mood-status" id="mood-status">
                <i class="fas fa-mouse-pointer"></i> Clique em uma express√£o para selecionar
            </div>
            <div class="mood-submit">
                <button class="btn btn-primary" onclick="app.enviarMood()" id="mood-submit-btn" disabled>
                    <i class="fas fa-paper-plane"></i> Enviar Meu Sentimento
                </button>
            </div>
            <div id="mood-result" class="mood-result hidden"></div>
        </div>

        <!-- ABA: ATA DE OCORR√äNCIAS -->
        <div id="tab-ata" class="tab-content">
            <!-- Filtros -->
            <div class="filters-container">
                <div class="filters-title">
                    <i class="fas fa-filter"></i> Filtrar Registros
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label><i class="fas fa-building"></i> Condom√≠nio</label>
                        <select id="filter-condo">
                            <option value="">Todos os condom√≠nios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Data Inicial</label>
                        <input type="date" id="filter-data-inicio">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Data Final</label>
                        <input type="date" id="filter-data-fim">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Tipo</label>
                        <select id="filter-tipo">
                            <option value="">Todos os tipos</option>
                            <option value="Informa√ß√£o">üìù Informa√ß√£o</option>
                            <option value="Ocorr√™ncia">‚ö†Ô∏è Ocorr√™ncia</option>
                            <option value="Incidente">üö® Incidente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tasks"></i> Status</label>
                        <select id="filter-status">
                            <option value="">Todos os status</option>
                            <option value="Em andamento">üîÑ Em andamento</option>
                            <option value="Finalizado">‚úÖ Finalizado</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-filter" onclick="app.aplicarFiltrosAtas()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <button class="btn btn-clear" onclick="app.limparFiltrosAtas()">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
                <div id="filtros-ativos-ata" class="filter-info"></div>
            </div>
            <div id="resultados-info-ata" style="margin-bottom: 1rem;"></div>

            <!-- Formul√°rio Nova Ata -->
            <div class="form-card fade-in">
                <h2><i class="fas fa-plus-circle"></i> Novo Registro de Ocorr√™ncia</h2>
                <div class="grid-2">
                    <div class="form-group">
                        <label><i class="fas fa-building"></i> Condom√≠nio</label>
                        <select id="ata-condo" onchange="app.updateCity()">
                            <option value="">Selecione um condom√≠nio...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-city"></i> Cidade</label>
                        <input type="text" id="ata-cidade" readonly style="background: #f8f9fa;">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Tipo de Registro</label>
                        <select id="ata-tipo">
                            <option value="Informa√ß√£o">üìù Informa√ß√£o</option>
                            <option value="Ocorr√™ncia">‚ö†Ô∏è Ocorr√™ncia</option>
                            <option value="Incidente">üö® Incidente</option>
                            <option value="Informa√ß√µes Fixas">üìå Informa√ß√µes Fixas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tasks"></i> Status</label>
                        <select id="ata-status">
                            <option value="Em andamento">üîÑ Em andamento</option>
                            <option value="Finalizado">‚úÖ Finalizado</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-align-left"></i> Descri√ß√£o dos Fatos</label>
                    <textarea id="ata-desc" rows="5" placeholder="Descreva detalhadamente os fatos ocorridos..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="app.saveAta()">
                    <i class="fas fa-save"></i> SALVAR REGISTRO
                </button>
            </div>

            <!-- Lista de Atas -->
            <div id="ata-lista"></div>
        </div>

        <!-- ABA: INFORMA√á√ïES FIXAS -->
        <div id="tab-fixas" class="tab-content hidden">
            <div class="fixed-info-container">
                <div class="fixed-info-header">
                    <i class="fas fa-thumbtack"></i>
                    <h3>Informa√ß√µes Fixas dos Condom√≠nios</h3>
                </div>
                <p style="color: #856404; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> Estas s√£o informa√ß√µes importantes que permanecem vis√≠veis para todos os operadores.
                </p>
            </div>
            <div id="fixas-lista"></div>
        </div>

        <!-- ABA: ORDEM DE SERVI√áO -->
        <div id="tab-os" class="tab-content hidden">
            <!-- Tela de Confirma√ß√£o de OS Enviada (oculta por padr√£o) -->
            <div id="os-confirmation-screen" class="os-confirmation hidden">
                <i class="fas fa-check-circle"></i>
                <h2>Ordem de Servi√ßo Aberta com Sucesso!</h2>
                <p style="font-size: 1.1rem; color: var(--gray); margin-bottom: 2rem;">
                    A sua ordem de servi√ßo foi registrada e enviada por e-mail.
                </p>
                <div class="details">
                    <div style="margin-bottom: 10px;">
                        <strong>üìã N√∫mero da OS:</strong> <span id="os-confirmation-id">OS-001</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üè¢ Condom√≠nio:</strong> <span id="os-confirmation-condo">-</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>‚ö†Ô∏è Gravidade:</strong> <span id="os-confirmation-gravidade">-</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üë§ Funcion√°rio:</strong> <span id="os-confirmation-funcionario">-</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üìß E-mail:</strong> <span id="os-confirmation-email">-</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üìÖ Data/Hora:</strong> <span id="os-confirmation-data">-</span>
                    </div>
                </div>
                <p style="margin-top: 1.5rem; color: var(--gray); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i>
                    Um e-mail foi enviado para <strong>londrina.tecnica1@porter.com.br, londrina.tecnicaplantao@porter.com.br, londrina.tenicaplant√£o1@porter.com.br</strong> com todos os detalhes.
                    Os t√©cnicos responder√£o diretamente por e-mail.
                </p>
                <div class="back-to-os">
                    <button class="btn btn-primary" onclick="app.voltarParaFormOS()">
                        <i class="fas fa-plus-circle"></i> Abrir Nova OS
                    </button>
                </div>
            </div>

            <!-- Formul√°rio OS (vis√≠vel por padr√£o) -->
            <div id="os-form-container">
                <div class="form-card os-form fade-in">
                    <h2><i class="fas fa-tools"></i> Nova Ordem de Servi√ßo</h2>
                    <!-- FORMUL√ÅRIO COM M√âTODO POST PARA FORMSUBMIT -->
                    <form id="os-form-email" action="https://formsubmit.co/londrina.operacional@porter.com.br" method="POST">
                        <!-- Campos ocultos do FormSubmit -->
                        <input type="hidden" name="_cc" value="londrina.tecnica1@porter.com.br,londrina.tecnicaplantao@porter.com.br,londrina.tenicaplantao1@porter.com.br">
                        <input type="hidden" name="_subject" value="[NOVA O.S] - Sistema Porter">
                        <input type="hidden" name="_template" value="table">
                        <input type="hidden" name="_captcha" value="false">
                        <input type="hidden" name="_next" value="#os-confirmation-screen">
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Condom√≠nio *</label>
                                <select id="os-condo" name="condominio" onchange="app.updateCityOS()" required>
                                    <option value="">Selecione um condom√≠nio...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-city"></i> Cidade</label>
                                <input type="text" id="os-cidade" name="cidade" readonly style="background: #f8f9fa;">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> Nome do Funcion√°rio *</label>
                                <input type="text" id="os-funcionario" name="funcionario" placeholder="Seu nome completo" required>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-envelope"></i> E-mail do Funcion√°rio *</label>
                                <input type="email" id="os-email" name="email" placeholder="seu.email@porter.com.br" required>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label><i class="fas fa-sitemap"></i> Setor/Departamento *</label>
                                <select id="os-setor" name="setor" required>
                                    <option value="">Selecione o setor...</option>
                                    <option value="Opera√ß√£o">Opera√ß√£o</option>
                                    <option value="Administrativo">Administrativo</option>
                                    <option value="T√©cnico">T√©cnico</option>
                                    <option value="RH">Recursos Humanos</option>
                                    <option value="Financeiro">Financeiro</option>
                                    <option value="Comercial">Comercial</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-exclamation-triangle"></i> Gravidade da Ocorr√™ncia *</label>
                                <select id="os-gravidade" name="gravidade" required>
                                    <option value="Baixa">üü¢ Baixa - Manuten√ß√£o Preventiva/Rotina</option>
                                    <option value="M√©dia" selected>üü° M√©dia - Reparo Necess√°rio</option>
                                    <option value="Alta">üî¥ Alta - Urgente/Problema Cr√≠tico</option>
                                    <option value="Emerg√™ncia">üö® Emerg√™ncia - Risco Imediato</option>
                                </select>
                                <small style="font-size: 0.8rem; color: #666;">Define prioridade e tempo de resposta</small>
                            </div>
                        </div>
                        <!-- üÜï CAMPO: T√âCNICO RESPONS√ÅVEL -->
                        <div class="form-group">
                            <label><i class="fas fa-user-cog"></i> T√©cnico respons√°vel</label>
                            <select id="os-tecnico" name="tecnico_responsavel">
                                <option value="">Selecione um t√©cnico (opcional)</option>
                                <optgroup label="T√âCNICOS LONDRINA">
                                    <option value="EVERTON ALAN - T√âCNICO PORTER">EVERTON ALAN - T√âCNICO PORTER</option>
                                    <option value="MARCIO JOSE DE BARROS - TEC PORTER">MARCIO JOSE DE BARROS - TEC PORTER</option>
                                    <option value="VALDEIR COITO - T√âCNICO PORTER">VALDEIR COITO - T√âCNICO PORTER</option>
                                </optgroup>
                                <optgroup label="AUXILIARES">
                                    <option value="WELINGTON SANTOS - AUXILIAR T√âCNICO">WELINGTON SANTOS - AUXILIAR T√âCNICO</option>
                                    <option value="CLEBERSON SILVA - AUXILIAR T√âCNICO T√ÅTICO PORTER">CLEBERSON SILVA - AUXILIAR T√âCNICO T√ÅTICO PORTER</option>
                                    <option value="EMANOEL THOMAZ - AUXILIAR T√âCNICO">EMANOEL THOMAZ - AUXILIAR T√âCNICO</option>
                                </optgroup>
                                <optgroup label="T√âCNICOS MARING√Å">
                                    <option value="VINICIUS MENDES - PORTER MARING√Å">VINICIUS MENDES - PORTER MARING√Å</option>
                                    <option value="ITALO - T√âCNICO PORTER">ITALO - T√âCNICO PORTER</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-align-left"></i> Descri√ß√£o do Problema *</label>
                            <textarea id="os-desc" name="descricao" rows="5" placeholder="Descreva detalhadamente o problema ou servi√ßo necess√°rio..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Data Preferencial para Atendimento</label>
                            <input type="date" id="os-data" name="data_preferencial">
                        </div>
                        <!-- Bot√£o para enviar o formul√°rio -->
                        <button type="submit" class="btn btn-info" onclick="app.abrirOSComEmail(event)">
                            <i class="fas fa-paper-plane"></i> ABRIR ORDEM DE SERVI√áO
                        </button>
                    </form>
                </div>

                <!-- NOVO: FILTRO POR GRAVIDADE NA LISTA -->
                <div style="margin: 2rem 0 1rem 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-list"></i> Ordens de Servi√ßo Recentes</h3>
                    <div style="display: flex; gap: 10px;">
                        <div class="btn-group">
                            <button class="btn btn-filter" onclick="app.filtrarOSTodas()">
                                Todas
                            </button>
                            <button class="btn btn-filter" style="background: #e74c3c20; color: #e74c3c; border: 1px solid #e74c3c40;" onclick="app.filtrarOSGravidade('Alta')">
                                üî¥ Alta
                            </button>
                            <button class="btn btn-filter" style="background: #f39c1220; color: #f39c12; border: 1px solid #f39c1240;" onclick="app.filtrarOSGravidade('M√©dia')">
                                üü° M√©dia
                            </button>
                            <button class="btn btn-filter" style="background: #27ae6020; color: #27ae60; border: 1px solid #27ae6040;" onclick="app.filtrarOSGravidade('Baixa')">
                                üü¢ Baixa
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Lista de OS -->
                <div id="os-lista"></div>
            </div>
        </div>

        <!-- NOVA ABA: CHAT GERAL -->
        <div id="tab-chat" class="tab-content hidden">
            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <strong><i class="fas fa-comments"></i> Chat Geral dos Operadores</strong>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Comunica√ß√£o r√°pida entre a equipe</div>
                    </div>
                    <div class="chat-admin-controls" id="chat-admin-controls" style="display: none;">
                        <button class="chat-clear-btn" onclick="app.clearChat()">
                            <i class="fas fa-trash"></i> Limpar Chat
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Mensagens ser√£o carregadas aqui -->
                </div>
                <div class="chat-input-area">
                    <textarea class="chat-input" id="chat-input" placeholder="Digite sua mensagem..." rows="2"></textarea>
                    <button class="btn btn-info" onclick="app.sendChatMessage()" id="chat-send-btn">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
            <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray); text-align: center;">
                <i class="fas fa-info-circle"></i> As mensagens s√£o vis√≠veis para todos os operadores logados
            </div>
        </div>

        <!-- NEW: ABA: CHAT PRIVADO -->
        <div id="tab-chat-privado" class="tab-content hidden">
            <div class="chat-container chat-private-container">
                <div class="chat-header chat-private-header">
                    <div>
                        <strong><i class="fas fa-user-secret"></i> Chat Privado</strong>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Conversa privada entre operadores</div>
                    </div>
                </div>
                
                <div class="private-chat-selector">
                    <div class="form-group">
                        <label><i class="fas fa-user-friends"></i> Conversar com:</label>
                        <select id="private-chat-target" onchange="app.loadPrivateChat()">
                            <option value="">Selecione um operador...</option>
                        </select>
                    </div>
                </div>
                
                <div class="chat-messages chat-private-messages" id="chat-private-messages">
                    <!-- Mensagens privadas ser√£o carregadas aqui -->
                </div>
                
                <div class="chat-input-area">
                    <textarea class="chat-input" id="chat-private-input" placeholder="Digite sua mensagem privada..." rows="2" disabled></textarea>
                    <button class="btn btn-info" onclick="app.sendPrivateChatMessage()" id="chat-private-send-btn" disabled>
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
            <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray); text-align: center;">
                <i class="fas fa-info-circle"></i> As mensagens s√£o vis√≠veis apenas para voc√™ e o destinat√°rio selecionado
            </div>
        </div>

        <!-- ABA: HIST√ìRICO -->
        <div id="tab-presenca" class="tab-content hidden">
            <div class="filters-container">
                <div class="filters-title">
                    <i class="fas fa-filter"></i> Filtrar Hist√≥rico
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Operador</label>
                        <select id="filter-presenca-operador">
                            <option value="">Todos os operadores</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Data Inicial</label>
                        <input type="date" id="filter-presenca-inicio">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Data Final</label>
                        <input type="date" id="filter-presenca-fim">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Turno</label>
                        <select id="filter-presenca-turno">
                            <option value="">Todos os turnos</option>
                            <option value="Diurno">üåû Diurno</option>
                            <option value="Noturno">üåô Noturno</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-filter" onclick="app.aplicarFiltrosPresenca()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <button class="btn btn-clear" onclick="app.limparFiltrosPresenca()">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <!-- Hist√≥rico de Acesso -->
            <h3 style="margin: 2rem 0 1rem 0;"><i class="fas fa-history"></i> Hist√≥rico de Acesso</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Operador</th>
                            <th><i class="fas fa-clock"></i> Turno</th>
                            <th><i class="fas fa-calendar"></i> Data</th>
                            <th><i class="fas fa-sign-in-alt"></i> Login</th>
                            <th><i class="fas fa-sign-out-alt"></i> Logoff</th>
                        </tr>
                    </thead>
                    <tbody id="presenca-lista"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE RELAT√ìRIO -->
<div class="modal" id="report-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-pdf"></i> Gerar Relat√≥rio PDF</h3>
            <button class="modal-close" onclick="app.closeReportModal()">&times;</button>
        </div>
        <div class="form-group">
            <label><i class="fas fa-building"></i> Condom√≠nio</label>
            <select id="report-condo">
                <option value="">Todos os condom√≠nios</option>
            </select>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label><i class="fas fa-calendar"></i> Data Inicial</label>
                <input type="date" id="report-data-inicio">
            </div>
            <div class="form-group">
                <label><i class="fas fa-calendar"></i> Data Final</label>
                <input type="date" id="report-data-fim">
            </div>
        </div>
        <div class="form-group">
            <label><i class="fas fa-tag"></i> Tipo de Conte√∫do</label>
            <select id="report-tipo">
                <option value="atas">üìã Ocorr√™ncias</option>
                <option value="fixas">üìå Informa√ß√µes Fixas</option>
                <option value="os">üîß Ordens de Servi√ßo</option>
                <option value="all">üìä Todos os Registros</option>
            </select>
        </div>
        <div class="pdf-preview" id="pdf-preview">
            <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
            </div>
            <p>Selecione as op√ß√µes e gere o relat√≥rio</p>
            <p style="font-size: 0.9rem; color: var(--gray);">O relat√≥rio ser√° gerado em PDF para impress√£o</p>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="app.generatePDF()">
                <i class="fas fa-download"></i> Gerar e Baixar PDF
            </button>
            <button class="btn btn-clear" onclick="app.closeReportModal()">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE COMENT√ÅRIOS -->
<div class="modal" id="comments-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-comments"></i> Coment√°rios</h3>
            <button class="modal-close" onclick="app.closeCommentsModal()">&times;</button>
        </div>
        <div id="comments-modal-content">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </div>
</div>

<!-- MODAL DE CONTROLE ADMIN -->
<div class="modal" id="admin-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-shield"></i> Controle Administrativo</h3>
            <button class="modal-close" onclick="app.closeAdminModal()">&times;</button>
        </div>
        <div id="admin-modal-content">
            <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
    </div>
</div>

<script>
// Dados do sistema
const DATA = {
    funcionarios: [
        { nome: "LA√çSSA PEREIRA DOS SANTOS XAVIER", user: "laissa.xavier", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "VANESSA LOPES SOUZA DE OLIVEIRA", user: "vanessa.oliveira", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "MARIA LUIZA ALEIXO ANTUNES", user: "maria.antunes", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "MARISA MENEGHETTI", user: "marisa.meneghetti", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "LUDMILA R CASSIANO", user: "ludmila.cassiano", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "MARIA GABRIELA ANTONIO", user: "maria.antonio", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "DENISE CRISTINA DE SOUSA", user: "denise.sousa", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "EDSON SILVA MAC√äDO", user: "edson.macedo", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "MARIA CLARA RAMOS", user: "maria.ramos", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "GABRIELY AMORIM CAMPOS", user: "gabriely.campos", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "SANDRA REGINA DA FRAN√áA SILVA", user: "sandra.silva", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "THAIS BENA LIMA", user: "thais.lima", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "ABNER CAVALCANTE", user: "abner.cavalcante", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "DAIANE LUCY RODRIGUES DE ALMEIDA", user: "daiane.almeida", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "ALINY MELQUIADES DE SOUZA", user: "aliny.souza", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "LOUISE COSTA", user: "louise.costa", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "ROSALIA TAIT KLINKERFUS", user: "rosalia.klinkerfus", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "MARIO ALEXANDRE CLEMENTIN", user: "mario.clementin", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "VANIA DO SOCORRO LEOCADIO", user: "vania.leocadio", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "JACKELINE ARAUJO SAMPAIO DIAS", user: "jackeline.dias", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "LUCAS VINICIUS DA SILVA", user: "lucas.v.silva", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "CARLOS HENRIQUE FERREIRA LEITE", user: "carlos.leite", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "LUIZ FERNANDO S MORYAMA DOS SANTOS", user: "luiz.santos", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "ERICK DE SOUZA RODRIGUES", user: "erick.rodrigues", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "MATHEUS ROBERTO BRASIL SILVA", user: "matheus.silva", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "WELINGTON FELIPE ALVES BARBOSA", user: "wellington.barbosa", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "KAIC VITOR MARTINS DE BRITO", user: "kaic.brito", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "DEISY SANTOS CRUZ", user: "deisy.cruz", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "DANIELE DA SILVA ROCHA", user: "daniele.rocha", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "ANA BEATRIZ PEREIRA", user: "ana.pereira", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "LUCAS DANIEL", user: "lucas.daniel", pass: "Porter@2026", role: "OPERADOR" },
        { nome: "ADMINISTRADOR PORTER", user: "admin.porter", pass: "Admin@2026", role: "ADMIN" }
    ],
    condominios: [
        { n: "ALAMEDA PINHEIROS", c: "Londrina" }, { n: "ALGARVE", c: "Londrina" }, { n: "AMADEUS", c: "Londrina" },
        { n: "AMARILIS", c: "Londrina" }, { n: "AMERICA", c: "Londrina" }, { n: "ANITA GARIBALDI", c: "Londrina" },
        { n: "AQUALUNA", c: "Londrina" }, { n: "ARIANE", c: "Londrina" }, { n: "ARQUITETO JULIO RIBEIRO", c: "Londrina" },
        { n: "ATHENAS", c: "Londrina" }, { n: "BARAO CATUAI", c: "Londrina" }, { n: "BASE - PORTER LONDRINA", c: "Londrina" },
        { n: "BELLEVILLE", c: "Londrina" }, { n: "BENTO MUNHOZ DA ROCHA NETTO II", c: "Maring√°" },
        { n: "BIARRITZ", c: "Londrina" }, { n: "BOSQUE", c: "Londrina" }, { n: "CAMPOS ELISEOS", c: "Londrina" },
        { n: "CASABLANCA", c: "Londrina" }, { n: "CASA CONDOMINIO (Londrina)", c: "Londrina" },
        { n: "CASA CONDOM√çNIO (Maring√°)", c: "Maring√°" }, { n: "CASARIO DO PORTO", c: "Londrina" },
        { n: "CENTRO EMPRESARIAL NEWTON CAMARA", c: "Londrina" }, { n: "CIDADE DOS PASSAROS", c: "Arapongas" },
        { n: "CITZEN PARK", c: "Maring√°" }, { n: "COMERCIAL CAMBARA", c: "Londrina" }, { n: "DOLCE VIE", c: "Londrina" },
        { n: "EBANO", c: "Londrina" }, { n: "ENSEADAS", c: "Londrina" }, { n: "EUROCENTER", c: "Londrina" },
        { n: "FERNANDA", c: "Londrina" }, { n: "FLOR DA MATA", c: "Londrina" }, { n: "FLOR DE LOTUS", c: "Londrina" },
        { n: "FLORENZA", c: "Londrina" }, { n: "GOLDEN GATE", c: "Londrina" }, { n: "GOLDENVILLE", c: "Londrina" },
        { n: "GRAO PARA", c: "Londrina" }, { n: "GREENFIELDS", c: "Londrina" }, { n: "HEIMTAL PARK", c: "Londrina" },
        { n: "HYDE PARK", c: "Londrina" }, { n: "INDREL INDUSTRIA DE REFRIGERACAO LONDRINENSE LTDA", c: "Londrina" },
        { n: "INEDITO", c: "Londrina" }, { n: "JOAO DINARDI", c: "Londrina" }, { n: "LAKE VAN GOGH", c: "Londrina" },
        { n: "LA SENA", c: "Camb√©" }, { n: "LE REVE", c: "Londrina" }, { n: "MAR DEL PLATA", c: "Londrina" },
        { n: "MAXIMUS RESIDENCE", c: "Londrina" }, { n: "MGL - MECANICA EIRELI", c: "Camb√©" },
        { n: "MONT BLANC", c: "Londrina" }, { n: "MORADA IMPERIAL", c: "Londrina" }, { n: "MUNDO NOVO", c: "Londrina" },
        { n: "NEW PLAZA RESIDENCE", c: "Maring√°" }, { n: "NICOLA PAGAN", c: "Londrina" },
        { n: "ORTIZ (Camb√©)", c: "Camb√©" }, { n: "PALAIS LAC DOR", c: "Londrina" }, { n: "PARQUE IMPERIAL", c: "Londrina" },
        { n: "PEROLA NEGRA", c: "Londrina" }, { n: "PETIT VILLE", c: "Londrina" }, { n: "POLARIS", c: "Londrina" },
        { n: "PORTLAND RESIDENCE", c: "Londrina" }, { n: "PRIME HOUSE", c: "Londrina" }, { n: "PRIVILEGE JAMAICA", c: "Londrina" },
        { n: "QUINTA DA BOA VISTA III A", c: "Londrina" }, { n: "QUINTA DA BOA VISTA VI", c: "Londrina" },
        { n: "RIO TEJO", c: "Maring√°" }, { n: "RIO TEVERE", c: "Maring√°" }, { n: "SANTOS", c: "Londrina" },
        { n: "SAO GABRIEL", c: "Maring√°" }, { n: "SERRA VERDE", c: "Londrina" }, { n: "SIRMIONE", c: "Maring√°" },
        { n: "SOLAR MONTREAUX", c: "Londrina" }, { n: "SPAZIO LAS PALMAS", c: "Londrina" },
        { n: "SPEZIA", c: "Londrina" }, { n: "STRAUSS BOULEVARD", c: "Londrina" }, { n: "TAPUIAS JARDIN", c: "Londrina" },
        { n: "TERRALIS JARDIN RESIDENCE", c: "Londrina" }, { n: "TERRASSE JARDIN", c: "Londrina" },
        { n: "TORRES BRASIL", c: "Londrina" }, { n: "UNIVERSITOP", c: "Londrina" },
        { n: "VENICE DOWNTOWN", c: "Londrina" }, { n: "VILLA BELLA (Camb√©)", c: "Camb√©" },
        { n: "VILLA DAS TORRES", c: "Camb√©" }, { n: "VILLAGE LA CORUNA", c: "Londrina" },
        { n: "VILLAGGIO DO ENGENHO", c: "Camb√©" }, { n: "VILLA ROMANA", c: "Londrina" },
        { n: "VISCONDE DE BARBACENA", c: "Londrina" }, { n: "VITTACE BOULEVARD", c: "Londrina" },
        { n: "VIVALDI BOULEVARD", c: "Londrina" }, { n: "VIVENDA DOS PESCADORES", c: "Maring√°" }
    ],
    // üÜï LISTA DE T√âCNICOS
    tecnicos: [
        { nome: "EVERTON ALAN - T√âCNICO PORTER", categoria: "T√âCNICOS LONDRINA" },
        { nome: "MARCIO JOSE DE BARROS - TEC PORTER", categoria: "T√âCNICOS LONDRINA" },
        { nome: "VALDEIR COITO - T√âCNICO PORTER", categoria: "T√âCNICOS LONDRINA" },
        { nome: "WELINGTON SANTOS - AUXILIAR T√âCNICO", categoria: "AUXILIARES" },
        { nome: "CLEBERSON SILVA - AUXILIAR T√âCNICO T√ÅTICO PORTER", categoria: "AUXILIARES" },
        { nome: "EMANOEL THOMAZ - AUXILIAR T√âCNICO", categoria: "AUXILIARES" },
        { nome: "VINICIUS MENDES - PORTER MARING√Å", categoria: "T√âCNICOS MARING√Å" },
        { nome: "ITALO - T√âCNICO PORTER", categoria: "T√âCNICOS MARING√Å" }
    ]
};

// Sistema principal
const app = {
    currentUser: null,
    selectedMood: null,
    currentCondoFilter: '',
    notifications: [],
    lastLogoffTime: null,
    chatInterval: null,
    privateChatInterval: null,
    moodInterval: null,
    onlineInterval: null,
    onlineUsers: [],
    lastOSId: null,
    currentPrivateChatTarget: null,

    init() {
        // GARANTIR que come√ßa na tela de login
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');

        // Limpar auto-preenchimento dos campos de login
        setTimeout(() => {
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            document.getElementById('login-turno').value = 'Diurno';
        }, 100);

        this.loadCondos();
        this.loadFiltros();
        this.loadNotifications();
        this.setupEventListeners();
        this.setupAutoSave();
        this.setupOSPreview();
        this.setupResponsive();

        // Configurar datas padr√£o
        const hoje = new Date();
        const umaSemanaAtras = new Date();
        umaSemanaAtras.setDate(umaSemanaAtras.getDate() - 7);
        
        document.getElementById('filter-data-inicio').value = umaSemanaAtras.toISOString().split('T')[0];
        document.getElementById('filter-data-fim').value = hoje.toISOString().split('T')[0];
        document.getElementById('filter-presenca-inicio').value = umaSemanaAtras.toISOString().split('T')[0];
        document.getElementById('filter-presenca-fim').value = hoje.toISOString().split('T')[0];
        document.getElementById('os-data').value = hoje.toISOString().split('T')[0];

        // Preencher datas do relat√≥rio
        document.getElementById('report-data-inicio').value = umaSemanaAtras.toISOString().split('T')[0];
        document.getElementById('report-data-fim').value = hoje.toISOString().split('T')[0];

        this.carregarFiltrosSalvos();

        // Configurar clique fora da lista de online
        document.addEventListener('click', (e) => {
            const onlineList = document.getElementById('online-users-list');
            const onlineDropdown = document.getElementById('online-users');
            if (onlineList && onlineList.style.display === 'block' &&
                !onlineDropdown.contains(e.target) &&
                !onlineList.contains(e.target)) {
                onlineList.style.display = 'none';
            }
        });

        // Configurar clique fora das notifica√ß√µes
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-bell') && !e.target.closest('.notifications-panel')) {
                document.getElementById('notifications-panel').classList.remove('show');
            }
        });
    },

    setupEventListeners() {
        // Enter no login
        document.getElementById('login-pass').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.login();
        });

        // Enter no chat
        document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendChatMessage();
            }
        });

        // FIX: chat individual - corrigir sele√ß√£o de destinat√°rio
        const privateChatSelect = document.getElementById('private-chat-target');
        if (privateChatSelect) {
            privateChatSelect.addEventListener('change', (e) => {
                this.currentPrivateChatTarget = e.target.value;
                this.loadPrivateChat();
            });
        }

        // Enter no chat privado
        document.getElementById('chat-private-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendPrivateChatMessage();
            }
        });

        // Salvar logoff quando a p√°gina for fechada
        window.addEventListener('beforeunload', () => {
            if (this.currentUser) {
                this.registrarLogoff();
            }
        });

        // FIX: bot√£o online - corrigir evento de toggle
        const onlineDropdown = document.getElementById('online-users');
        if (onlineDropdown) {
            onlineDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleOnlineUsers();
            });
        }

        // Configurar envio do formul√°rio de OS
        const osForm = document.getElementById('os-form-email');
        if (osForm) {
            osForm.addEventListener('submit', (e) => {
                this.abrirOSComEmail(e);
            });
        }
    },

    setupAutoSave() {
        setInterval(() => {
            if (this.currentUser) {
                this.salvarSessao();
            }
        }, 30000);
    },

    setupResponsive() {
        window.addEventListener('resize', () => {
            if (this.currentUser) {
                if (window.innerWidth > 1200) {
                    document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('sidebar').classList.remove('show');
                } else {
                    document.getElementById('sidebar').style.display = 'none';
                }
            }
        });
    },

    setupOnlineTracking() {
        // Atualizar a cada 30 segundos
        this.onlineInterval = setInterval(() => {
            if (this.currentUser) {
                this.updateOnlineUsers();
            }
        }, 30000);
        // Inicializar imediamente
        this.updateOnlineUsers();
    },

    getMoodStatusTexto(mood) {
        const statusMap = {
            'üò†': 'Zangado hoje',
            'üòî': 'Triste hoje',
            'üòê': 'Neutro hoje',
            'üôÇ': 'Feliz hoje',
            'üòÑ': 'Radiante hoje'
        };
        return statusMap[mood] || 'N√£o avaliado';
    },

    // FIX: bot√£o online - fun√ß√£o atualizada para mostrar corretamente
    updateOnlineUsers() {
        if (!this.currentUser) return;
        
        const agora = new Date();
        // Buscar usu√°rios realmente online do localStorage
        let usuariosOnline = [];
        
        // Adicionar usu√°rio atual
        const moodAtual = this.getMoodAtual();
        const statusMood = this.getMoodStatusTexto(moodAtual);
        usuariosOnline.push({
            ...this.currentUser,
            lastActivity: agora.toISOString(),
            mood: moodAtual,
            moodStatus: statusMood,
            isCurrentUser: true
        });
        
        // Verificar se h√° outros usu√°rios com sess√£o ativa (√∫ltimos 5 minutos)
        try {
            const sessaoSalva = localStorage.getItem('porter_last_session');
            if (sessaoSalva) {
                const sessao = JSON.parse(sessaoSalva);
                if (sessao.user !== this.currentUser.user) {
                    const tempoSessao = new Date(sessao.lastActivity);
                    const diferencaMinutos = (agora - tempoSessao) / (1000 * 60);
                    if (diferencaMinutos < 5) {
                        // Este √© um usu√°rio que est√° "online"
                        const outroUsuario = DATA.funcionarios.find(f => f.user === sessao.user);
                        if (outroUsuario) {
                            usuariosOnline.push({
                                ...outroUsuario,
                                lastActivity: sessao.lastActivity,
                                mood: 'üòê', // Mood padr√£o para usu√°rios n√£o ativos
                                moodStatus: 'Online h√° ' + Math.floor(diferencaMinutos) + ' min',
                                isCurrentUser: false,
                                turno: sessao.turno || 'Diurno'
                            });
                        }
                    }
                }
            }
        } catch (e) {
            console.log('Erro ao buscar sess√µes:', e);
        }
        
        this.onlineUsers = usuariosOnline;
        
        // Atualizar contador
        const onlineCount = document.getElementById('online-count');
        if (onlineCount) {
            if (this.onlineUsers.length === 1) {
                onlineCount.textContent = '1 (apenas voc√™)';
                onlineCount.style.color = '#f39c12';
            } else {
                onlineCount.textContent = this.onlineUsers.length;
                onlineCount.style.color = '#2ecc71';
            }
        }
        
        // Se a lista estiver vis√≠vel, atualizar
        const onlineList = document.getElementById('online-users-list');
        if (onlineList && onlineList.style.display === 'block') {
            this.renderOnlineUsersList();
        }
        
        this.salvarSessao();
    },

    // FIX: bot√£o online - fun√ß√£o para mostrar/ocultar lista
    toggleOnlineUsers() {
        const onlineList = document.getElementById('online-users-list');
        if (onlineList.style.display === 'block') {
            onlineList.style.display = 'none';
        } else {
            this.renderOnlineUsersList();
            onlineList.style.display = 'block';
        }
    },

    renderOnlineUsersList() {
        const onlineList = document.getElementById('online-users-list');
        onlineList.innerHTML = '';
        
        if (this.onlineUsers.length === 0) {
            onlineList.innerHTML = `
                <div class="online-user-item">
                    <div class="online-user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="online-user-info">
                        <div class="online-user-name">Nenhum operador online</div>
                        <div class="online-user-role">Apenas voc√™ est√° conectado</div>
                    </div>
                </div>
            `;
            return;
        }
        
        this.onlineUsers.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'online-user-item';
            userItem.innerHTML = `
                <div class="online-user-avatar" style="background: ${this.getCorPorMood(user.mood)}">
                    <i class="fas fa-user"></i>
                </div>
                <div class="online-user-info">
                    <div class="online-user-name">
                        ${user.nome.split(' ')[0]} ${user.isCurrentUser ? '(Voc√™)' : ''}
                        ${user.role === 'ADMIN' ? ' üëë' : ''}
                    </div>
                    <div class="online-user-role">
                        ${user.turno} | ${user.moodStatus || 'N√£o avaliado'}
                    </div>
                </div>
                <div class="online-status"></div>
            `;
            onlineList.appendChild(userItem);
        });
    },

    formatarTempoAtivo(dataAtividade) {
        const agora = new Date();
        const diferenca = agora - new Date(dataAtividade);
        const minutos = Math.floor(diferenca / (1000 * 60));
        
        if (minutos < 1) return 'Agora mesmo';
        if (minutos === 1) return 'H√° 1 minuto';
        if (minutos < 60) return `H√° ${minutos} minutos`;
        
        const horas = Math.floor(minutos / 60);
        if (horas === 1) return 'H√° 1 hora';
        return `H√° ${horas} horas`;
    },

    getCorPorMood(mood) {
        const cores = {
            'üò†': '#ffeaa7',
            'üòî': '#fd79a8',
            'üòê': '#dfe6e9',
            'üôÇ': '#a29bfe',
            'üòÑ': '#55efc4'
        };
        return cores[mood] || '#e8f4fc';
    },

    toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    },

    registrarLogoff() {
        if (!this.currentUser) return;
        
        const logoffs = JSON.parse(localStorage.getItem('porter_logoffs') || '[]');
        const logoffData = {
            user: this.currentUser.user,
            nome: this.currentUser.nome,
            data: new Date().toLocaleDateString('pt-BR'),
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            turno: this.currentUser.turno
        };
        
        logoffs.unshift(logoffData);
        if (logoffs.length > 200) logoffs.pop();
        localStorage.setItem('porter_logoffs', JSON.stringify(logoffs));
        
        this.lastLogoffTime = new Date().toISOString();
        localStorage.setItem('porter_last_logoff', this.lastLogoffTime);
        
        // Limpar intervalos
        if (this.chatInterval) {
            clearInterval(this.chatInterval);
            this.chatInterval = null;
        }
        
        if (this.privateChatInterval) {
            clearInterval(this.privateChatInterval);
            this.privateChatInterval = null;
        }
        
        if (this.moodInterval) {
            clearInterval(this.moodInterval);
            this.moodInterval = null;
        }
        
        if (this.onlineInterval) {
            clearInterval(this.onlineInterval);
            this.onlineInterval = null;
        }
        
        // Limpar sess√£o do usu√°rio atual
        localStorage.removeItem('porter_last_session');
    },

    salvarSessao() {
        if (!this.currentUser) return;
        
        const sessionData = {
            user: this.currentUser.user,
            nome: this.currentUser.nome,
            lastActivity: new Date().toISOString(),
            turno: this.currentUser.turno,
            role: this.currentUser.role
        };
        
        localStorage.setItem('porter_last_session', JSON.stringify(sessionData));
    },

    loadCondos() {
        const sidebarList = document.getElementById('condo-list');
        sidebarList.innerHTML = '';
        
        const ataSelect = document.getElementById('ata-condo');
        const osSelect = document.getElementById('os-condo');
        const filterSelect = document.getElementById('filter-condo');
        const reportSelect = document.getElementById('report-condo');
        
        ataSelect.innerHTML = '<option value="">Selecione um condom√≠nio...</option>';
        osSelect.innerHTML = '<option value="">Selecione um condom√≠nio...</option>';
        filterSelect.innerHTML = '<option value="">Todos os condom√≠nios</option>';
        reportSelect.innerHTML = '<option value="">Todos os condom√≠nios</option>';
        
        DATA.condominios.sort((a,b) => a.n.localeCompare(b.n)).forEach(c => {
            const condoItem = document.createElement('div');
            condoItem.className = 'condo-item';
            condoItem.dataset.condo = c.n;
            condoItem.onclick = () => this.filtrarPorCondominio(c.n);
            condoItem.innerHTML = `
                <div class="condo-name">${c.n}</div>
                <div class="condo-badge" id="badge-${c.n.replace(/\s+/g, '-')}">0</div>
            `;
            sidebarList.appendChild(condoItem);
            
            [ataSelect, osSelect, filterSelect, reportSelect].forEach(select => {
                const opt = document.createElement('option');
                opt.value = c.n;
                opt.textContent = c.n;
                select.appendChild(opt);
            });
        });
    },

    loadFiltros() {
        const filterOperador = document.getElementById('filter-presenca-operador');
        filterOperador.innerHTML = '<option value="">Todos os operadores</option>';
        
        DATA.funcionarios.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(f => {
            let opt = document.createElement('option');
            opt.value = f.nome;
            opt.textContent = f.nome;
            filterOperador.appendChild(opt);
        });
    },

    carregarMoodOptions() {
        const MOOD_OPTIONS = [
            { id: 1, label: "Zangado", color: "#e74c3c", status: "üò† Zangado", description: "Raiva ou tristeza profunda" },
            { id: 2, label: "Triste", color: "#e67e22", status: "üòî Triste", description: "Des√¢nimo ou insatisfa√ß√£o" },
            { id: 3, label: "Neutro", color: "#f1c40f", status: "üòê Neutro", description: "Indiferente ou t√©dio" },
            { id: 4, label: "Feliz", color: "#2ecc71", status: "üôÇ Feliz", description: "Bem-estar e satisfa√ß√£o" },
            { id: 5, label: "Radiante", color: "#27ae60", status: "üòÑ Radiante", description: "Felicidade plena e euforia" }
        ];
        
        const container = document.getElementById('mood-options');
        container.innerHTML = '';
        
        MOOD_OPTIONS.forEach(mood => {
            const moodElement = document.createElement('div');
            moodElement.className = 'mood-option';
            moodElement.dataset.id = mood.id;
            moodElement.style.color = mood.color;
            moodElement.onclick = () => this.selecionarMood(mood.id);
            
            let svgContent = '';
            switch(mood.id) {
                case 1: svgContent = `<circle cx="18" cy="18" r="3" fill="${mood.color}" /><circle cx="32" cy="18" r="3" fill="${mood.color}" /><path d="M15 35 Q25 25 35 35" stroke="${mood.color}" stroke-width="3" fill="none" />`; break;
                case 2: svgContent = `<circle cx="18" cy="18" r="3" fill="${mood.color}" /><circle cx="32" cy="18" r="3" fill="${mood.color}" /><path d="M15 32 Q25 28 35 32" stroke="${mood.color}" stroke-width="3" fill="none" />`; break;
                case 3: svgContent = `<circle cx="18" cy="18" r="3" fill="${mood.color}" /><circle cx="32" cy="18" r="3" fill="${mood.color}" /><line x1="15" y1="30" x2="35" y2="30" stroke="${mood.color}" stroke-width="3" />`; break;
                case 4: svgContent = `<circle cx="18" cy="18" r="3" fill="${mood.color}" /><circle cx="32" cy="18" r="3" fill="${mood.color}" /><path d="M15 28 Q25 33 35 28" stroke="${mood.color}" stroke-width="3" fill="none" />`; break;
                case 5: svgContent = `<circle cx="18" cy="18" r="3" fill="${mood.color}" /><circle cx="32" cy="18" r="3" fill="${mood.color}" /><path d="M12 25 Q25 40 38 25" stroke="${mood.color}" stroke-width="3" fill="none" />`; break;
            }
            
            moodElement.innerHTML = `
                <div class="mood-face" style="border-color: ${mood.color}">
                    <svg viewBox="0 0 50 50">${svgContent}</svg>
                </div>
                <div class="mood-label">${mood.label}</div>
                <div class="mood-description">${mood.description}</div>
            `;
            
            container.appendChild(moodElement);
        });
    },

    selecionarMood(moodId) {
        const MOOD_OPTIONS = [
            { id: 1, status: "üò† Zangado" },
            { id: 2, status: "üòî Triste" },
            { id: 3, status: "üòê Neutro" },
            { id: 4, status: "üôÇ Feliz" },
            { id: 5, status: "üòÑ Radiante" }
        ];
        
        this.selectedMood = MOOD_OPTIONS.find(m => m.id === moodId);
        
        document.querySelectorAll('.mood-option').forEach(el => {
            el.classList.remove('selected');
        });
        
        document.querySelector(`.mood-option[data-id="${moodId}"]`).classList.add('selected');
        
        document.getElementById('mood-status').innerHTML = `
            <i class="fas fa-check-circle" style="color: ${document.querySelector(`.mood-option[data-id="${moodId}"]`).style.color}"></i>
            <span>Selecionado: <strong>${this.selectedMood.status}</strong></span>
        `;
        
        document.getElementById('mood-submit-btn').disabled = false;
    },

    enviarMood() {
        if (!this.selectedMood || !this.currentUser) return;
        
        const hoje = new Date();
        const dataISO = hoje.toISOString().split('T')[0];
        
        let moods = JSON.parse(localStorage.getItem('porter_moods') || '[]');
        const indexExistente = moods.findIndex(m => m.user === this.currentUser.user && m.dataISO === dataISO);
        
        const moodData = {
            user: this.currentUser.user,
            nome: this.currentUser.nome,
            moodStatus: this.selectedMood.status,
            data: hoje.toLocaleDateString('pt-BR'),
            dataISO: dataISO,
            hora: hoje.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            turno: this.currentUser.turno,
            timestamp: hoje.toISOString()
        };
        
        if (indexExistente !== -1) {
            moods[indexExistente] = moodData;
        } else {
            moods.unshift(moodData);
        }
        
        if (moods.length > 500) moods = moods.slice(0, 500);
        localStorage.setItem('porter_moods', JSON.stringify(moods));
        
        const resultDiv = document.getElementById('mood-result');
        resultDiv.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <strong>Sentimento registrado com sucesso!</strong>
            <span>${this.selectedMood.status}</span>
        `;
        resultDiv.classList.remove('hidden');
        
        document.getElementById('mood-submit-btn').disabled = true;
        
        // Atualizar lista de online
        this.updateOnlineUsers();
        
        // Atualizar a √°rea do usu√°rio
        this.updateUserInfo();
        
        setTimeout(() => {
            resultDiv.classList.add('hidden');
            this.verificarMoodHoje();
        }, 5000);
    },

    verificarMoodHoje() {
        if (!this.currentUser) return;
        
        const hojeISO = new Date().toISOString().split('T')[0];
        const moods = JSON.parse(localStorage.getItem('porter_moods') || '[]');
        const jaAvaliouHoje = moods.some(m => m.user === this.currentUser.user && m.dataISO === hojeISO);
        
        if (jaAvaliouHoje) {
            setTimeout(() => {
                const moodContainer = document.getElementById('mood-check-container');
                moodContainer.classList.add('hidden');
            }, 2000);
        }
    },

    getMoodAtual() {
        if (!this.currentUser) return 'üòê';
        
        const hojeISO = new Date().toISOString().split('T')[0];
        const moods = JSON.parse(localStorage.getItem('porter_moods') || '[]');
        const moodHoje = moods.find(m => m.user === this.currentUser.user && m.dataISO === hojeISO);
        
        return moodHoje ? moodHoje.moodStatus.split(' ')[0] : 'üòê';
    },

    updateCity() {
        const condoName = document.getElementById('ata-condo').value;
        const condo = DATA.condominios.find(c => c.n === condoName);
        document.getElementById('ata-cidade').value = condo ? condo.c : "";
    },

    updateCityOS() {
        const condoName = document.getElementById('os-condo').value;
        const condo = DATA.condominios.find(c => c.n === condoName);
        document.getElementById('os-cidade').value = condo ? condo.c : "";
    },

    login() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value;
        const t = document.getElementById('login-turno').value;
        
        const user = DATA.funcionarios.find(f => f.user === u && f.pass === p);
        
        if (user) {
            this.currentUser = {
                ...user,
                turno: t,
                loginTime: new Date().toLocaleString('pt-BR'),
                loginTimestamp: new Date().toISOString(),
                loginDate: new Date().toLocaleDateString('pt-BR'),
                loginHour: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})
            };
            
            localStorage.setItem('porter_session', JSON.stringify(this.currentUser));
            
            // Registrar login
            let presencas = JSON.parse(localStorage.getItem('porter_presencas') || '[]');
            presencas.unshift({
                nome: user.nome,
                turno: t,
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                timestamp: new Date().toISOString(),
                dataISO: new Date().toISOString().split('T')[0],
                tipo: 'login'
            });
            
            if (presencas.length > 100) presencas = presencas.slice(0, 100);
            localStorage.setItem('porter_presencas', JSON.stringify(presencas));
            
            this.showApp();
        } else {
            // üÜï VERIFICAR SE √â T√âCNICO
            const tecnico = DATA.tecnicos.find(t => {
                const nomeTecnico = t.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.');
                return u === nomeTecnico && p === "Tecnico@2026";
            });
            
            if (tecnico) {
                this.currentUser = {
                    nome: tecnico.nome,
                    user: tecnico.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.'),
                    role: "T√âCNICO",
                    turno: t,
                    loginTime: new Date().toLocaleString('pt-BR'),
                    loginTimestamp: new Date().toISOString(),
                    loginDate: new Date().toLocaleDateString('pt-BR'),
                    loginHour: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})
                };
                
                localStorage.setItem('porter_session', JSON.stringify(this.currentUser));
                
                let presencas = JSON.parse(localStorage.getItem('porter_presencas') || '[]');
                presencas.unshift({
                    nome: tecnico.nome,
                    turno: t,
                    data: new Date().toLocaleDateString('pt-BR'),
                    hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                    timestamp: new Date().toISOString(),
                    dataISO: new Date().toISOString().split('T')[0],
                    tipo: 'login'
                });
                
                if (presencas.length > 100) presencas = presencas.slice(0, 100);
                localStorage.setItem('porter_presencas', JSON.stringify(presencas));
                
                this.showApp();
            } else {
                alert('Credenciais inv√°lidas! Verifique usu√°rio e senha.');
            }
        }
    },

    showApp() {
        // Transi√ß√£o suave
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        
        // MOSTRAR SIDEBAR AP√ìS LOGIN
        if (window.innerWidth > 1200) {
            document.getElementById('sidebar').style.display = 'block';
        }
        
        this.updateUserInfo();
        this.carregarMoodOptions();
        
        const jaAvaliou = this.jaAvaliouHoje();
        if (!jaAvaliou) {
            document.getElementById('mood-check-container').classList.remove('hidden');
        }
        
        this.renderAll();
        this.updateNotificationBadges();
        this.salvarSessao();
        
        // üÜï ATUALIZAR OPERADORES ONLINE IMEDIATAMENTE
        this.updateOnlineUsers();
        
        // Se for admin, mostrar controles
        if (this.currentUser.role === 'ADMIN' || this.currentUser.role === 'T√âCNICO') {
            document.getElementById('admin-controls').style.display = 'flex';
        }
        
        // Iniciar chat
        this.loadChat();
        this.chatInterval = setInterval(() => this.loadChat(), 5000);
        
        // NEW: Iniciar chat privado
        this.loadPrivateChatUsers();
        this.privateChatInterval = setInterval(() => {
            if (this.currentPrivateChatTarget) {
                this.loadPrivateChat();
            }
        }, 5000);
        
        // Iniciar tracking de online
        this.setupOnlineTracking();
        
        // üÜï Inicializar visto por
        this.registrarVisualizacaoChat();
        
        // Auto-preenche campos do funcion√°rio na OS se estiver logado
        if (this.currentUser) {
            document.getElementById('os-funcionario').value = this.currentUser.nome;
            document.getElementById('os-email').value = `${this.currentUser.user}@porter.com.br`;
        }
    },

    updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        if (this.currentUser) {
            const moodAtual = this.getMoodAtual();
            userInfo.innerHTML = `
                <div class="user-info-name">
                    <span style="font-size: 1.2rem; margin-right: 5px;">${moodAtual}</span>
                    <strong>${this.currentUser.nome.split(' ')[0]}</strong>
                    ${this.currentUser.role === 'T√âCNICO' ? '<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px;">T√âCNICO</span>' : ''}
                </div>
                <div class="user-info-time">
                    <i class="far fa-calendar"></i> ${this.currentUser.loginDate}
                    <i class="far fa-clock"></i> ${this.currentUser.loginHour}
                </div>
                <div class="user-info-role">
                    ${this.currentUser.turno} | ${this.currentUser.role}
                </div>
            `;
        }
    },

    jaAvaliouHoje() {
        if (!this.currentUser) return true;
        
        const hojeISO = new Date().toISOString().split('T')[0];
        const moods = JSON.parse(localStorage.getItem('porter_moods') || '[]');
        return moods.some(m => m.user === this.currentUser.user && m.dataISO === hojeISO);
    },

    logout() {
        if (confirm('Deseja realmente sair do sistema?')) {
            this.registrarLogoff();
            
            // Limpar intervalos primeiro
            if (this.chatInterval) {
                clearInterval(this.chatInterval);
                this.chatInterval = null;
            }
            
            if (this.privateChatInterval) {
                clearInterval(this.privateChatInterval);
                this.privateChatInterval = null;
            }
            
            if (this.moodInterval) {
                clearInterval(this.moodInterval);
                this.moodInterval = null;
            }
            
            if (this.onlineInterval) {
                clearInterval(this.onlineInterval);
                this.onlineInterval = null;
            }
            
            // Limpar sess√£o
            localStorage.removeItem('porter_session');
            localStorage.removeItem('porter_last_session');
            this.currentUser = null;
            
            // Esconder aplica√ß√£o
            document.getElementById('main-content').classList.add('hidden');
            
            // Mostrar login com transi√ß√£o suave
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Resetar formul√°rio de login
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            
            this.showMessage('Logoff realizado com sucesso!', 'success');
        }
    },

    switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(tabId).classList.remove('hidden');
        btn.classList.add('active');
        
        // Se for a aba de chat, carregar mensagens e marcar como visualizado
        if (tabId === 'tab-chat') {
            this.loadChat();
            this.marcarChatComoVisualizado();
        }
        
        // Se for a aba de chat privado, carregar usu√°rios
        if (tabId === 'tab-chat-privado') {
            this.loadPrivateChatUsers();
        }
    },

    updateTabCounts() {
        const atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        const fixas = atas.filter(a => a.tipo && a.tipo.includes('Informa√ß√µes Fixas'));
        const os = JSON.parse(localStorage.getItem('porter_os') || '[]');
        const chat = JSON.parse(localStorage.getItem('porter_chat') || '[]');
        
        document.getElementById('tab-count-ata').textContent = atas.length;
        document.getElementById('tab-count-fixas').textContent = fixas.length;
        document.getElementById('tab-count-os').textContent = os.length;
        
        // üÜï Usar fun√ß√£o atualizarBadgeChat
        this.atualizarBadgeChat();
        
        // NEW: Atualizar badge do chat privado
        this.atualizarBadgeChatPrivado();
    },

    atualizarBadgeChat() {
        const chat = JSON.parse(localStorage.getItem('porter_chat') || '[]');
        const ultimaVisualizacao = localStorage.getItem('porter_chat_last_view') || '0';
        const ultimaVisualizacaoTime = parseInt(ultimaVisualizacao);
        
        const mensagensNaoVisualizadas = chat.filter(msg => {
            if (!msg.timestamp) return false;
            const msgTime = new Date(msg.timestamp).getTime();
            return msgTime > ultimaVisualizacaoTime;
        }).length;
        
        const badge = document.getElementById('chat-badge');
        if (mensagensNaoVisualizadas > 0) {
            badge.textContent = mensagensNaoVisualizadas > 99 ? '99+' : mensagensNaoVisualizadas;
            badge.style.display = 'inline-block';
            
            const chatTab = document.querySelector('.chat-tab');
            if (chatTab) {
                chatTab.classList.add('has-new-message');
            }
        } else {
            badge.textContent = '0';
            badge.style.display = 'none';
            
            const chatTab = document.querySelector('.chat-tab');
            if (chatTab) {
                chatTab.classList.remove('has-new-message');
            }
        }
        
        return mensagensNaoVisualizadas;
    },

    atualizarBadgeChatPrivado() {
        if (!this.currentUser) return 0;
        
        const privateChats = JSON.parse(localStorage.getItem('porter_chat_privado') || '{}');
        let totalNaoVisualizadas = 0;
        
        // Verificar todas as conversas privadas do usu√°rio atual
        Object.keys(privateChats).forEach(chatId => {
            const [user1, user2] = chatId.split('_');
            if (user1 === this.currentUser.user || user2 === this.currentUser.user) {
                const mensagens = privateChats[chatId];
                const ultimaVisualizacaoKey = `porter_chat_privado_last_view_${chatId}`;
                const ultimaVisualizacao = localStorage.getItem(ultimaVisualizacaoKey) || '0';
                const ultimaVisualizacaoTime = parseInt(ultimaVisualizacao);
                
                const mensagensNaoVisualizadas = mensagens.filter(msg => {
                    if (!msg.timestamp) return false;
                    const msgTime = new Date(msg.timestamp).getTime();
                    return msgTime > ultimaVisualizacaoTime && msg.sender !== this.currentUser.user;
                }).length;
                
                totalNaoVisualizadas += mensagensNaoVisualizadas;
            }
        });
        
        const badge = document.getElementById('chat-private-badge');
        if (totalNaoVisualizadas > 0) {
            badge.textContent = totalNaoVisualizadas > 99 ? '99+' : totalNaoVisualizadas;
            badge.style.display = 'inline-block';
        } else {
            badge.textContent = '0';
            badge.style.display = 'none';
        }
        
        return totalNaoVisualizadas;
    },

    marcarChatComoVisualizado() {
        localStorage.setItem('porter_chat_last_view', Date.now().toString());
        this.atualizarBadgeChat();
        this.registrarVisualizacaoChat();
    },

    registrarVisualizacaoChat() {
        if (!this.currentUser) return;
        
        const visualizacoes = JSON.parse(localStorage.getItem('porter_chat_views') || '{}');
        const agora = Date.now();
        
        visualizacoes[this.currentUser.user] = {
            nome: this.currentUser.nome,
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            data: new Date().toLocaleDateString('pt-BR'),
            timestamp: agora,
            mood: this.getMoodAtual()
        };
        
        // Limpar visualiza√ß√µes antigas (mais de 1 hora)
        Object.keys(visualizacoes).forEach(user => {
            if (agora - visualizacoes[user].timestamp > 60 * 60 * 1000) {
                delete visualizacoes[user];
            }
        });
        
        localStorage.setItem('porter_chat_views', JSON.stringify(visualizacoes));
    },

    obterVisualizacoesRecentes() {
        const visualizacoes = JSON.parse(localStorage.getItem('porter_chat_views') || '{}');
        const agora = Date.now();
        const cincoMinutos = 5 * 60 * 1000;
        
        const visualizacoesRecentes = Object.entries(visualizacoes)
            .filter(([user, data]) => agora - data.timestamp <= cincoMinutos)
            .map(([user, data]) => ({
                user,
                ...data
            }));
        
        return visualizacoesRecentes;
    },

    aplicarFiltrosAtas() {
        this.filtrosAtas = {
            condo: document.getElementById('filter-condo').value,
            dataInicio: document.getElementById('filter-data-inicio').value,
            dataFim: document.getElementById('filter-data-fim').value,
            tipo: document.getElementById('filter-tipo').value,
            status: document.getElementById('filter-status').value
        };
        
        localStorage.setItem('porter_filtros_atas', JSON.stringify(this.filtrosAtas));
        this.mostrarFiltrosAtivosAtas();
        this.renderAta();
    },

    limparFiltrosAtas() {
        const hoje = new Date();
        const umaSemanaAtras = new Date();
        umaSemanaAtras.setDate(umaSemanaAtras.getDate() - 7);
        
        document.getElementById('filter-condo').value = '';
        document.getElementById('filter-data-inicio').value = umaSemanaAtras.toISOString().split('T')[0];
        document.getElementById('filter-data-fim').value = hoje.toISOString().split('T')[0];
        document.getElementById('filter-tipo').value = '';
        document.getElementById('filter-status').value = '';
        
        this.filtrosAtas = { condo: '', dataInicio: '', dataFim: '', tipo: '', status: '' };
        localStorage.removeItem('porter_filtros_atas');
        
        this.mostrarFiltrosAtivosAtas();
        this.renderAta();
        this.showMessage('Filtros limpos!', 'success');
    },

    filtrarPorCondominio(condoName) {
        document.getElementById('filter-condo').value = condoName;
        this.currentCondoFilter = condoName;
        this.aplicarFiltrosAtas();
        
        // Destacar item na sidebar
        document.querySelectorAll('.condo-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const condoItem = document.querySelector(`.condo-item[data-condo="${condoName}"]`);
        if (condoItem) {
            condoItem.classList.add('active');
        }
        
        // Fechar sidebar em mobile
        if (window.innerWidth <= 1200) {
            this.toggleSidebar();
        }
    },

    aplicarFiltrosPresenca() {
        this.filtrosPresenca = {
            operador: document.getElementById('filter-presenca-operador').value,
            dataInicio: document.getElementById('filter-presenca-inicio').value,
            dataFim: document.getElementById('filter-presenca-fim').value,
            turno: document.getElementById('filter-presenca-turno').value
        };
        
        localStorage.setItem('porter_filtros_presenca', JSON.stringify(this.filtrosPresenca));
        this.renderPresenca();
    },

    limparFiltrosPresenca() {
        const hoje = new Date();
        const umaSemanaAtras = new Date();
        umaSemanaAtras.setDate(umaSemanaAtras.getDate() - 7);
        
        document.getElementById('filter-presenca-operador').value = '';
        document.getElementById('filter-presenca-inicio').value = umaSemanaAtras.toISOString().split('T')[0];
        document.getElementById('filter-presenca-fim').value = hoje.toISOString().split('T')[0];
        document.getElementById('filter-presenca-turno').value = '';
        
        this.filtrosPresenca = { operador: '', dataInicio: '', dataFim: '', turno: '' };
        localStorage.removeItem('porter_filtros_presenca');
        
        this.renderPresenca();
        this.showMessage('Filtros limpos!', 'success');
    },

    carregarFiltrosSalvos() {
        const filtrosAtasSalvos = localStorage.getItem('porter_filtros_atas');
        if (filtrosAtasSalvos) {
            this.filtrosAtas = JSON.parse(filtrosAtasSalvos);
            document.getElementById('filter-condo').value = this.filtrosAtas.condo || '';
            document.getElementById('filter-data-inicio').value = this.filtrosAtas.dataInicio || '';
            document.getElementById('filter-data-fim').value = this.filtrosAtas.dataFim || '';
            document.getElementById('filter-tipo').value = this.filtrosAtas.tipo || '';
            document.getElementById('filter-status').value = this.filtrosAtas.status || '';
        }
        
        const filtrosPresencaSalvos = localStorage.getItem('porter_filtros_presenca');
        if (filtrosPresencaSalvos) {
            this.filtrosPresenca = JSON.parse(filtrosPresencaSalvos);
            document.getElementById('filter-presenca-operador').value = this.filtrosPresenca.operador || '';
            document.getElementById('filter-presenca-inicio').value = this.filtrosPresenca.dataInicio || '';
            document.getElementById('filter-presenca-fim').value = this.filtrosPresenca.dataFim || '';
            document.getElementById('filter-presenca-turno').value = this.filtrosPresenca.turno || '';
        }
    },

    mostrarFiltrosAtivosAtas() {
        const container = document.getElementById('filtros-ativos-ata');
        const filtros = [];
        
        if (this.filtrosAtas.condo) filtros.push(`Condom√≠nio: ${this.filtrosAtas.condo}`);
        if (this.filtrosAtas.dataInicio) filtros.push(`De: ${this.formatarDataBR(this.filtrosAtas.dataInicio)}`);
        if (this.filtrosAtas.dataFim) filtros.push(`At√©: ${this.formatarDataBR(this.filtrosAtas.dataFim)}`);
        if (this.filtrosAtas.tipo) filtros.push(`Tipo: ${this.filtrosAtas.tipo}`);
        if (this.filtrosAtas.status) filtros.push(`Status: ${this.filtrosAtas.status}`);
        
        if (filtros.length > 0) {
            container.innerHTML = `<strong>Filtros ativos:</strong> ${filtros.join(' | ')}`;
        } else {
            container.innerHTML = 'Nenhum filtro ativo';
        }
    },

    formatarDataBR(dataISO) {
        if (!dataISO) return '';
        const [ano, mes, dia] = dataISO.split('-');
        return `${dia}/${mes}/${ano}`;
    },

    setupOSPreview() {
        const gravidadeSelect = document.getElementById('os-gravidade');
        if (gravidadeSelect) {
            gravidadeSelect.addEventListener('change', function() {
                app.atualizarPreviewGravidade(this.value);
            });
            this.atualizarPreviewGravidade(gravidadeSelect.value);
        }
    },

    atualizarPreviewGravidade(gravidade) {
        const previewDiv = document.getElementById('os-preview-prioridade');
        const previewTexto = document.getElementById('os-preview-gravidade');
        const previewIcone = document.getElementById('os-preview-icone');
        const previewPrazo = document.getElementById('os-preview-prazo');
        
        if (!previewDiv) return;
        
        const configs = {
            'Baixa': {
                texto: 'üü¢ GRAVIDADE BAIXA',
                icone: 'fa-info-circle',
                cor: '#27ae60',
                prazo: 'Prazo: 7 dias √∫teis'
            },
            'M√©dia': {
                texto: 'üü° GRAVIDADE M√âDIA',
                icone: 'fa-exclamation-circle',
                cor: '#f39c12',
                prazo: 'Prazo: 3 dias √∫teis'
            },
            'Alta': {
                texto: 'üî¥ GRAVIDADE ALTA',
                icone: 'fa-exclamation-triangle',
                cor: '#e74c3c',
                prazo: 'Prazo: 24 horas'
            },
            'Emerg√™ncia': {
                texto: 'üö® EMERG√äNCIA',
                icone: 'fa-bell',
                cor: '#8b0000',
                prazo: 'Prazo: 4 horas - ATEN√á√ÉO M√ÅXIMA'
            }
        };
        
        const config = configs[gravidade] || configs['M√©dia'];
        
        previewTexto.textContent = config.texto;
        previewTexto.style.color = config.cor;
        previewIcone.innerHTML = `<i class="fas ${config.icone}" style="color: ${config.cor}"></i>`;
        previewPrazo.textContent = config.prazo;
        previewDiv.style.display = 'block';
        previewDiv.style.borderLeft = `4px solid ${config.cor}`;
    },

    calcularPrazoPorGravidade(gravidade) {
        const prazos = {
            'Baixa': '7 dias √∫teis',
            'M√©dia': '3 dias √∫teis',
            'Alta': '24 horas',
            'Emerg√™ncia': '4 horas'
        };
        return prazos[gravidade] || '3 dias √∫teis';
    },

    getCorGravidade(gravidade) {
        const cores = {
            'Baixa': '#27ae60',
            'M√©dia': '#f39c12',
            'Alta': '#e74c3c',
            'Emerg√™ncia': '#8b0000'
        };
        return cores[gravidade] || '#666';
    },

    getIconeGravidade(gravidade) {
        const icones = {
            'Baixa': 'fa-info-circle',
            'M√©dia': 'fa-exclamation-circle',
            'Alta': 'fa-exclamation-triangle',
            'Emerg√™ncia': 'fa-bell'
        };
        return icones[gravidade] || 'fa-circle';
    },

    saveAta() {
        const condo = document.getElementById('ata-condo').value;
        const desc = document.getElementById('ata-desc').value.trim();
        const tipo = document.getElementById('ata-tipo').value;
        
        if (!condo || !desc) {
            alert('Preencha todos os campos obrigat√≥rios! (Condom√≠nio e Descri√ß√£o)');
            return;
        }
        
        const novaAta = {
            id: Date.now(),
            condo,
            cidade: document.getElementById('ata-cidade').value,
            tipo: tipo,
            status: document.getElementById('ata-status').value,
            desc,
            operador: this.currentUser.nome,
            user: this.currentUser.user,
            turno: this.currentUser.turno,
            data: new Date().toLocaleDateString('pt-BR'),
            dataISO: new Date().toISOString().split('T')[0],
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            comentarios: [],
            fixa: tipo.includes('Informa√ß√µes Fixas')
        };
        
        let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        atas.unshift(novaAta);
        
        if (atas.length > 200) atas = atas.slice(0, 200);
        localStorage.setItem('porter_atas', JSON.stringify(atas));
        
        this.criarNotificacao(condo, tipo, desc);
        
        // Limpar formul√°rio
        document.getElementById('ata-desc').value = "";
        document.getElementById('ata-condo').value = "";
        document.getElementById('ata-cidade').value = "";
        
        this.showMessage('Registro salvo com sucesso!', 'success');
        this.renderAll();
        this.updateNotificationBadges();
    },

    criarNotificacao(condo, tipo, desc) {
        const notificacao = {
            id: Date.now(),
            condo,
            tipo,
            desc: desc.length > 100 ? desc.substring(0, 100) + '...' : desc,
            data: new Date().toLocaleDateString('pt-BR'),
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            lida: false
        };
        
        let notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        notificacoes.unshift(notificacao);
        
        if (notificacoes.length > 50) notificacoes.pop();
        localStorage.setItem('porter_notificacoes', JSON.stringify(notificacoes));
        
        if (tipo === 'Ordem de Servi√ßo') {
            this.criarNotificacaoChat(`Nova OS criada em ${condo}: ${desc.substring(0, 80)}...`);
        }
        
        this.loadNotifications();
    },

    criarNotificacaoChat(texto) {
        let notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        const notificacao = {
            id: Date.now(),
            condo: 'Chat Geral',
            tipo: 'chat',
            desc: texto,
            data: new Date().toLocaleDateString('pt-BR'),
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            lida: false
        };
        
        notificacoes.unshift(notificacao);
        if (notificacoes.length > 50) notificacoes.pop();
        localStorage.setItem('porter_notificacoes', JSON.stringify(notificacoes));
        
        this.loadNotifications();
    },

    criarNotificacaoChatComAcao(chatMessage) {
        const notificacao = {
            id: Date.now(),
            condo: 'Chat Geral',
            tipo: 'chat_mensagem',
            desc: `Nova mensagem de ${chatMessage.sender}: ${chatMessage.message.substring(0, 50)}${chatMessage.message.length > 50 ? '...' : ''}`,
            data: new Date().toLocaleDateString('pt-BR'),
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            lida: false,
            acao: {
                tipo: 'ir_para_chat',
                mensagemId: chatMessage.id,
                sender: chatMessage.sender
            },
            destaque: true
        };
        
        let notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        notificacoes.unshift(notificacao);
        
        if (notificacoes.length > 50) notificacoes.pop();
        localStorage.setItem('porter_notificacoes', JSON.stringify(notificacoes));
        
        this.loadNotifications();
        this.updateNotificationBadges();
        this.atualizarBadgeChat();
    },

    loadNotifications() {
        const notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        this.notifications = notificacoes;
        
        const list = document.getElementById('notifications-list');
        list.innerHTML = '';
        
        if (notificacoes.length === 0) {
            list.innerHTML = `
                <div class="notification-item">
                    <div style="text-align: center; color: var(--gray); padding: 2rem;">
                        <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Nenhuma notifica√ß√£o</p>
                    </div>
                </div>
            `;
            return;
        }
        
        notificacoes.forEach(notif => {
            const item = document.createElement('div');
            item.className = `notification-item ${notif.lida ? '' : 'unread'} ${notif.destaque ? 'destaque' : ''}`;
            item.dataset.tipo = notif.tipo;
            item.onclick = (e) => {
                e.stopPropagation();
                this.processarNotificacao(notif);
            };
            
            let icon = 'üìù';
            if (notif.tipo === 'chat_mensagem') icon = 'üí¨';
            if (notif.tipo.includes('Ocorr√™ncia')) icon = '‚ö†Ô∏è';
            if (notif.tipo.includes('Incidente')) icon = 'üö®';
            if (notif.tipo.includes('Fixas')) icon = 'üìå';
            if (notif.tipo === 'chat') icon = 'üí¨';
            if (notif.tipo === 'Ordem de Servi√ßo') icon = 'üîß';
            
            const acaoRapida = notif.tipo === 'chat_mensagem' ?
                `<button class="btn btn-sm btn-success" style="margin-top: 8px; padding: 4px 10px; font-size: 0.8rem;"
                 onclick="app.irParaChatAgora(event, ${notif.acao?.mensagemId})">
                    <i class="fas fa-comment"></i> Ver no Chat
                </button>` : '';
            
            item.innerHTML = `
                <div class="notification-condo">${icon} ${notif.condo}</div>
                <div style="margin: 5px 0;">${notif.desc}</div>
                <div class="notification-time">${notif.data} ${notif.hora}</div>
                ${acaoRapida}
            `;
            
            list.appendChild(item);
        });
        
        this.updateNotificationBadges();
    },

    processarNotificacao(notificacao) {
        this.marcarNotificacaoComoLida(notificacao.id);
        
        if (notificacao.acao) {
            switch(notificacao.acao.tipo) {
                case 'ir_para_chat':
                    this.irParaChat(notificacao.acao.mensagemId);
                    break;
            }
        }
        
        document.getElementById('notifications-panel').classList.remove('show');
    },

    irParaChat(mensagemId = null) {
        const chatTabBtn = document.querySelector('.chat-tab');
        if (chatTabBtn) {
            this.switchTab('tab-chat', chatTabBtn);
        } else {
            const chatTab = document.querySelector('.tab-btn.chat-tab');
            if (chatTab) {
                this.switchTab('tab-chat', chatTab);
            }
        }
        
        this.loadChat();
        this.marcarChatComoVisualizado();
        
        if (mensagemId) {
            setTimeout(() => {
                this.destacarMensagemChat(mensagemId);
            }, 500);
        }
        
        setTimeout(() => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.focus();
            }
        }, 300);
    },

    irParaChatAgora(event, mensagemId) {
        event.stopPropagation();
        event.preventDefault();
        this.irParaChat(mensagemId);
    },

    updateNotificationBadges() {
        const notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        const naoLidas = notificacoes.filter(n => !n.lida).length;
        
        const badge = document.getElementById('notification-count');
        if (naoLidas > 0) {
            badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
        
        DATA.condominios.forEach(condo => {
            const condoNotificacoes = notificacoes.filter(n => n.condo === condo.n && !n.lida);
            const condoBadge = document.getElementById(`badge-${condo.n.replace(/\s+/g, '-')}`);
            
            if (condoBadge) {
                if (condoNotificacoes.length > 0) {
                    condoBadge.textContent = condoNotificacoes.length > 9 ? '9+' : condoNotificacoes.length;
                    condoBadge.classList.add('has-notification');
                } else {
                    condoBadge.classList.remove('has-notification');
                }
            }
        });
        
        this.updateTabCounts();
    },

    toggleNotifications() {
        const panel = document.getElementById('notifications-panel');
        const estaAberto = panel.classList.contains('show');
        
        if (!estaAberto) {
            this.marcarTodasNotificacoesComoLidas();
        }
        
        panel.classList.toggle('show');
    },

    marcarTodasNotificacoesComoLidas() {
        let notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        notificacoes = notificacoes.map(notif => ({ ...notif, lida: true }));
        localStorage.setItem('porter_notificacoes', JSON.stringify(notificacoes));
        
        this.loadNotifications();
        this.updateNotificationBadges();
    },

    marcarNotificacaoComoLida(id) {
        let notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        const index = notificacoes.findIndex(n => n.id === id);
        
        if (index !== -1) {
            notificacoes[index].lida = true;
            localStorage.setItem('porter_notificacoes', JSON.stringify(notificacoes));
            this.loadNotifications();
        }
    },

    clearNotifications() {
        localStorage.removeItem('porter_notificacoes');
        this.loadNotifications();
    },

    adicionarComentario(ataId, texto) {
        if (!texto.trim()) return;
        
        let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        const index = atas.findIndex(a => a.id === ataId);
        
        if (index !== -1) {
            if (!atas[index].comentarios) atas[index].comentarios = [];
            atas[index].comentarios.unshift({
                id: Date.now(),
                autor: this.currentUser.nome,
                user: this.currentUser.user,
                texto: texto,
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('porter_atas', JSON.stringify(atas));
            this.renderAta();
            this.renderFixas();
            this.showMessage('Coment√°rio adicionado!', 'success');
        }
    },

    // FIX: BOT√ÉO COMENTAR - FUNCIONANDO CORRETAMENTE
    abrirComentarios(ataId) {
        let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        const ata = atas.find(a => a.id === ataId);
        
        if (!ata) return;
        
        const modalContent = document.getElementById('comments-modal-content');
        modalContent.innerHTML = `
            <h4><i class="fas fa-building"></i> ${ata.condo} - ${ata.data} ${ata.hora}</h4>
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--accent);">
                <strong><i class="fas fa-align-left"></i> Descri√ß√£o:</strong>
                <p style="white-space: pre-wrap; margin-top: 8px; padding: 10px; background: white; border-radius: 6px;">${ata.desc}</p>
            </div>
            <div class="comment-form">
                <h5><i class="fas fa-edit"></i> Adicionar Coment√°rio</h5>
                <textarea
                    id="novo-comentario-texto"
                    placeholder="Digite seu coment√°rio aqui..."
                    rows="4"
                    data-ata-id="${ataId}"
                ></textarea>
                <button class="btn btn-primary" onclick="app.adicionarComentarioModal(${ataId})" style="align-self: flex-end;">
                    <i class="fas fa-paper-plane"></i> Enviar Coment√°rio
                </button>
            </div>
            <div class="comments-title" style="margin-top: 2rem;">
                <i class="fas fa-comments"></i> Coment√°rios (${ata.comentarios ? ata.comentarios.length : 0})
            </div>
            <div class="comment-list" id="modal-comment-list">
                ${ata.comentarios && ata.comentarios.length > 0 ?
                    ata.comentarios.map(c => `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-author">
                                    <i class="fas fa-user"></i> ${c.autor}
                                </span>
                                <span class="comment-time">${c.data} ${c.hora}</span>
                            </div>
                            <div class="comment-text">${c.texto}</div>
                        </div>
                    `).join('') :
                    '<p style="text-align: center; color: var(--gray); padding: 2rem; background: #f8f9fa; border-radius: 8px;">Nenhum coment√°rio ainda. Seja o primeiro a comentar!</p>'
                }
            </div>
        `;
        
        document.getElementById('comments-modal').classList.add('show');
        
        setTimeout(() => {
            const campoTexto = document.getElementById('novo-comentario-texto');
            if (campoTexto) campoTexto.focus();
        }, 300);
    },

    // FIX: BOT√ÉO COMENTAR - ENVIO DIRETO SEM FECHAR MODAL
    adicionarComentarioModal(ataId) {
        const textoInput = document.getElementById('novo-comentario-texto');
        if (!textoInput) return;
        
        const texto = textoInput.value.trim();
        if (!texto) {
            alert('Por favor, digite um coment√°rio antes de enviar!');
            textoInput.focus();
            return;
        }
        
        this.adicionarComentario(ataId, texto);
        textoInput.value = '';
        
        // Recarregar os coment√°rios no modal sem fechar
        setTimeout(() => {
            this.abrirComentarios(ataId);
        }, 100);
    },

    closeCommentsModal() {
        document.getElementById('comments-modal').classList.remove('show');
    },

    renderFixas() {
        const list = document.getElementById('fixas-lista');
        const atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        const fixas = atas.filter(a => a.fixa);
        
        if (fixas.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-thumbtack"></i>
                    <h3>Nenhuma informa√ß√£o fixa</h3>
                    <p>Para criar uma informa√ß√£o fixa, selecione "Informa√ß√µes Fixas" no tipo de registro.</p>
                </div>
            `;
            return;
        }
        
        list.innerHTML = '';
        
        fixas.forEach(a => {
            const podeExcluir = this.currentUser && (this.currentUser.role === 'ADMIN' || a.user === this.currentUser.user);
            
            const card = document.createElement('div');
            card.className = 'ata-card fixed fade-in';
            card.innerHTML = `
                <div class="ata-header">
                    <span><i class="far fa-calendar"></i> ${a.data} | <i class="far fa-clock"></i> ${a.hora} | <i class="fas fa-user-clock"></i> Turno: ${a.turno}</span>
                    <span class="status-badge status-fixo">
                        <i class="fas fa-thumbtack"></i> FIXA
                    </span>
                </div>
                <div class="ata-condo"><i class="fas fa-building"></i> ${a.condo} (${a.cidade})</div>
                <div class="ata-type fixed"><i class="fas fa-tag"></i> ${a.tipo}</div>
                <div style="white-space: pre-wrap; margin: 15px 0; padding: 15px; background: #fff3cd30; border-radius: 6px; line-height: 1.5;">
                    ${a.desc}
                </div>
                <div style="font-size: 0.85rem; color: #666; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <i class="fas fa-user-edit"></i> Operador: ${a.operador}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="app.abrirComentarios(${a.id})">
                            <i class="fas fa-comments"></i> Coment√°rios (${a.comentarios ? a.comentarios.length : 0})
                        </button>
                        ${podeExcluir ?
                            `<button class="btn btn-danger" onclick="app.deleteAta(${a.id})">
                                <i class="fas fa-trash"></i> Excluir
                            </button>` :
                            '<span style="font-size: 0.8rem; color: var(--gray);"><i class="fas fa-lock"></i> Apenas autor/Admin</span>'
                        }
                    </div>
                </div>
            `;
            
            list.appendChild(card);
        });
    },

    // üÜï FUN√á√ÉO PRINCIPAL DE ENVIO DE OS COM E-MAIL
    abrirOSComEmail(event) {
        // Prevenir envio padr√£o do formul√°rio
        if (event) event.preventDefault();
        
        // Validar campos obrigat√≥rios
        const condo = document.getElementById('os-condo').value;
        const funcionario = document.getElementById('os-funcionario').value.trim();
        const email = document.getElementById('os-email').value.trim();
        const setor = document.getElementById('os-setor').value;
        const gravidade = document.getElementById('os-gravidade').value;
        const desc = document.getElementById('os-desc').value.trim();
        
        if (!condo || !funcionario || !email || !setor || !gravidade || !desc) {
            alert('Por favor, preencha todos os campos obrigat√≥rios marcados com *');
            return;
        }
        
        // Validar e-mail
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Por favor, insira um e-mail v√°lido');
            document.getElementById('os-email').focus();
            return;
        }
        
        // Gerar ID da OS
        const osId = 'OS-' + Date.now().toString().slice(-6);
        this.lastOSId = osId;
        
        // Obter data e hora atual
        const agora = new Date();
        const dataHora = agora.toLocaleString('pt-BR');
        const dataISO = agora.toISOString().split('T')[0];
        const hora = agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        
        // Criar objeto da OS para salvar no sistema
        const novaOS = {
            id: Date.now(),
            osId: osId,
            condo,
            cidade: document.getElementById('os-cidade').value,
            gravidade,
            desc,
            dataOS: document.getElementById('os-data').value || dataISO,
            data: agora.toLocaleDateString('pt-BR'),
            dataISO: dataISO,
            hora: hora,
            funcionario: funcionario,
            email: email,
            setor: setor,
            operador: this.currentUser ? this.currentUser.nome : funcionario,
            user: this.currentUser ? this.currentUser.user : 'anonimo',
            turno: this.currentUser ? this.currentUser.turno : 'N√£o informado',
            status: 'Em branco', // üÜï STATUS PADR√ÉO
            statusOS: 'Em branco', // üÜï STATUS ESPEC√çFICO DA OS
            timestamp: agora.toISOString(),
            prazoResposta: this.calcularPrazoPorGravidade(gravidade),
            corGravidade: this.getCorGravidade(gravidade),
            enviadoPorEmail: true,
            dataEnvioEmail: agora.toISOString(),
            tecnicoResponsavel: document.getElementById('os-tecnico').value || '' // üÜï T√âCNICO RESPONS√ÅVEL
        };
        
        // Salvar no localStorage
        let osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        osList.unshift(novaOS);
        
        if (osList.length > 100) osList = osList.slice(0, 100);
        localStorage.setItem('porter_os', JSON.stringify(osList));
        
        // Atualizar contagem de OS
        this.updateTabCounts();
        
        // Adicionar campos ocultos com informa√ß√µes adicionais
        this.adicionarCamposOcultosForm(osId, dataHora, novaOS.prazoResposta);
        
        // Mostrar mensagem de processamento
        this.showMessage('Enviando Ordem de Servi√ßo...', 'info');
        
        // Submeter o formul√°rio para o FormSubmit
        setTimeout(() => {
            // Submeter formul√°rio
            const form = document.getElementById('os-form-email');
            form.submit();
            
            // Mostrar tela de confirma√ß√£o
            this.mostrarConfirmacaoOS(novaOS);
            
            // Criar notifica√ß√£o
            this.criarNotificacao(condo, 'Ordem de Servi√ßo', `Nova OS ${osId}: ${gravidade} - ${desc.substring(0, 50)}...`);
            
            this.showMessage('Ordem de Servi√ßo aberta com sucesso!', 'success');
        }, 100);
    },

    // üÜï FUN√á√ÉO PARA ADICIONAR CAMPOS OCULTOS AO FORMUL√ÅRIO
    adicionarCamposOcultosForm(osId, dataHora, prazoResposta) {
        const form = document.getElementById('os-form-email');
        
        // Remover campos ocultos anteriores (se houver)
        ['os-id', 'data-hora', 'prazo-resposta'].forEach(name => {
            const existing = form.querySelector(`input[name="${name}"]`);
            if (existing) existing.remove();
        });
        
        // Adicionar campos ocultos com informa√ß√µes adicionais
        const camposOcultos = [
            { name: 'os-id', value: osId },
            { name: 'data-hora', value: dataHora },
            { name: 'prazo-resposta', value: prazoResposta },
            { name: 'sistema', value: 'Porter OS System' },
            { name: 'prioridade', value: document.getElementById('os-gravidade').value }
        ];
        
        camposOcultos.forEach(campo => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = campo.name;
            input.value = campo.value;
            form.appendChild(input);
        });
    },

    // üÜï FUN√á√ÉO PARA MOSTRAR TELA DE CONFIRMA√á√ÉO
    mostrarConfirmacaoOS(osData) {
        // Ocultar formul√°rio
        document.getElementById('os-form-container').classList.add('hidden');
        
        // Mostrar tela de confirma√ß√£o
        const confirmationScreen = document.getElementById('os-confirmation-screen');
        confirmationScreen.classList.remove('hidden');
        
        // Preencher dados na tela de confirma√ß√£o
        document.getElementById('os-confirmation-id').textContent = osData.osId;
        document.getElementById('os-confirmation-condo').textContent = osData.condo;
        document.getElementById('os-confirmation-gravidade').textContent = osData.gravidade;
        document.getElementById('os-confirmation-funcionario').textContent = osData.funcionario;
        document.getElementById('os-confirmation-email').textContent = osData.email;
        document.getElementById('os-confirmation-data').textContent = `${osData.data} ${osData.hora}`;
        
        // Registrar envio no hist√≥rico
        this.registrarEnvioDetalhadoOS(osData);
    },

    // üÜï FUN√á√ÉO PARA VOLTAR AO FORMUL√ÅRIO DE OS
    voltarParaFormOS() {
        // Mostrar formul√°rio
        document.getElementById('os-form-container').classList.remove('hidden');
        
        // Ocultar tela de confirma√ß√£o
        document.getElementById('os-confirmation-screen').classList.add('hidden');
        
        // Limpar formul√°rio
        document.getElementById('os-form-email').reset();
        
        // Restaurar cidade
        this.updateCityOS();
        
        // Auto-preenche campos do funcion√°rio se estiver logado
        if (this.currentUser) {
            document.getElementById('os-funcionario').value = this.currentUser.nome;
            document.getElementById('os-email').value = `${this.currentUser.user}@porter.com.br`;
        }
    },

    registrarEnvioDetalhadoOS(osData) {
        let historico = JSON.parse(localStorage.getItem('porter_os_emails') || '[]');
        
        const registro = {
            id: Date.now(),
            os_id: osData.id,
            os_number: osData.osId,
            data: new Date().toLocaleString('pt-BR'),
            destinatarios: ['londrina.tecnica1@porter.com.br', 'londrina.tecnicaplantao@porter.com.br', 'londrina.tenicaplant√£o1@porter.com.br'],
            condo: osData.condo,
            gravidade: osData.gravidade,
            funcionario: osData.funcionario,
            setor: osData.setor,
            email: osData.email,
            assunto: `[NOVA O.S] - ${osData.setor} - ${osData.funcionario}`,
            sucesso: true,
            data_envio: new Date().toISOString()
        };
        
        historico.unshift(registro);
        if (historico.length > 50) historico.pop();
        localStorage.setItem('porter_os_emails', JSON.stringify(historico));
    },

    gerarCorpoEmailOS(osData) {
        return `========================================
ORDEM DE SERVI√áO - PORTER 2026
========================================

üìã INFORMA√á√ïES DA OS
----------------------------------------
‚Ä¢ N√∫mero: ${osData.osId}
‚Ä¢ Condom√≠nio: ${osData.condo}
‚Ä¢ Cidade: ${osData.cidade}
‚Ä¢ Setor: ${osData.setor}
‚Ä¢ Gravidade: ${osData.gravidade}
‚Ä¢ Prazo: ${osData.prazoResposta || '3 dias √∫teis'}
‚Ä¢ Data OS: ${new Date(osData.dataOS).toLocaleDateString('pt-BR')}
‚Ä¢ T√©cnico respons√°vel: ${osData.tecnicoResponsavel || 'N√£o definido'}

üë§ INFORMA√á√ïES DO SOLICITANTE
----------------------------------------
‚Ä¢ Funcion√°rio: ${osData.funcionario}
‚Ä¢ E-mail: ${osData.email}
‚Ä¢ Operador: ${osData.operador}

üìÖ DATAS E HOR√ÅRIOS
----------------------------------------
‚Ä¢ Aberta em: ${osData.data} √†s ${osData.hora}
‚Ä¢ Turno: ${osData.turno}
‚Ä¢ Status: ${osData.statusOS || 'Em branco'}

üìù DESCRI√á√ÉO DO PROBLEMA/SERVI√áO
----------------------------------------
${osData.desc}

========================================
ATA OPERACIONAL PORTER - 2026
E-mail autom√°tico - N√£o responda
========================================`;
    },

    mostrarDetalhesEmailOS(osData, emails) {
        const corpoEmail = this.gerarCorpoEmailOS(osData);
        
        const modalContent = `
            <div style="padding: 20px; max-width: 800px;">
                <h3><i class="fas fa-envelope"></i> Detalhes do E-mail da OS</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong><i class="fas fa-paper-plane"></i> De:</strong> sistema@porter.com.br<br>
                    <strong><i class="fas fa-users"></i> Para:</strong> ${emails.join(', ')}<br>
                    <strong><i class="fas fa-tag"></i> Assunto:</strong> [PORTER OS] ${osData.gravidade} - ${osData.condo}
                </div>
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;
                    margin: 15px 0; font-family: monospace; white-space: pre-wrap;
                    max-height: 300px; overflow-y: auto;">
                    ${corpoEmail}
                </div>
                <div style="background: #e8f4fc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <i class="fas fa-info-circle"></i> <strong>Nota:</strong>
                    Em produ√ß√£o, este e-mail seria enviado automaticamente para todos os destinat√°rios.
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="app.copiarConteudoEmail()">
                        <i class="fas fa-copy"></i> Copiar Conte√∫do
                    </button>
                    <button class="btn btn-success" onclick="app.abrirClienteEmail('${osData.condo}', '${emails.join(',')}')">
                        <i class="fas fa-envelope-open"></i> Abrir no Cliente de E-mail
                    </button>
                    <button class="btn btn-clear" onclick="app.fecharModalEmail()">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        
        this.criarModal('Detalhes do E-mail', modalContent);
    },

    criarModal(titulo, conteudo) {
        this.fecharModalEmail();
        
        const modal = document.createElement('div');
        modal.id = 'modal-email-detalhes';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 9999; padding: 20px;
        `;
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 900px;
                width: 100%; max-height: 90vh; overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0; display: flex; justify-content: space-between; align-items: center;">
                        ${titulo}
                        <button onclick="app.fecharModalEmail()" style="background: none; border: none;
                        font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
                    </h3>
                </div>
                <div>${conteudo}</div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },

    fecharModalEmail() {
        const modal = document.getElementById('modal-email-detalhes');
        if (modal) modal.remove();
    },

    copiarConteudoEmail() {
        const modal = document.getElementById('modal-email-detalhes');
        const conteudo = modal?.querySelector('pre, .conteudo-email')?.innerText || '';
        
        if (conteudo) {
            navigator.clipboard.writeText(conteudo)
                .then(() => this.showMessage('Conte√∫do copiado!', 'success'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = conteudo;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    this.showMessage('Conte√∫do copiado!', 'success');
                });
        }
    },

    abrirClienteEmail(condo, emails) {
        const assunto = encodeURIComponent(`[PORTER OS] ${condo}`);
        const corpo = encodeURIComponent(`Prezado,\n\nSegue Ordem de Servi√ßo do condom√≠nio ${condo}.\n\nAtenciosamente,\nSistema Porter`);
        
        window.open(`mailto:${emails}?subject=${assunto}&body=${corpo}`, '_blank');
        this.showMessage('Cliente de e-mail aberto! Preencha o corpo com os detalhes da OS.', 'info');
    },

    filtrarOSTodas() {
        this.renderOS();
    },

    filtrarOSGravidade(gravidade) {
        const osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        const filtradas = osList.filter(os => os.gravidade === gravidade);
        this.renderOSList(filtradas, `Filtradas por gravidade: ${gravidade}`);
    },

    // üÜï FUN√á√ÉO PARA ATUALIZAR STATUS DA OS
    atualizarStatusOS(osId, novoStatus) {
        let osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        const index = osList.findIndex(os => os.id === osId);
        
        if (index !== -1) {
            osList[index].statusOS = novoStatus;
            osList[index].status = novoStatus; // Mant√©m compatibilidade
            osList[index].dataAtualizacao = new Date().toISOString();
            osList[index].atualizadoPor = this.currentUser.nome;
            
            localStorage.setItem('porter_os', JSON.stringify(osList));
            this.renderOS();
            this.showMessage('Status atualizado com sucesso!', 'success');
        }
    },

    // üÜï FUN√á√ÉO PARA EXCLUIR OS (APENAS T√âCNICO)
    excluirOS(osId) {
        if (this.currentUser.role !== 'T√âCNICO') {
            alert('Apenas t√©cnicos podem excluir Ordens de Servi√ßo.');
            return;
        }
        
        if (!confirm('Tem certeza que deseja excluir esta Ordem de Servi√ßo?')) {
            return;
        }
        
        let osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        const osIndex = osList.findIndex(os => os.id === osId);
        
        if (osIndex !== -1) {
            // Registrar exclus√£o
            let exclusoes = JSON.parse(localStorage.getItem('porter_exclusoes_os') || '[]');
            exclusoes.unshift({
                osId: osList[osIndex].osId,
                condo: osList[osIndex].condo,
                excluidoPor: this.currentUser.nome,
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('porter_exclusoes_os', JSON.stringify(exclusoes));
            
            // Remover OS
            osList.splice(osIndex, 1);
            localStorage.setItem('porter_os', JSON.stringify(osList));
            
            this.renderOS();
            this.showMessage('Ordem de Servi√ßo exclu√≠da com sucesso!', 'success');
        }
    },

    renderOSList(osList, titulo = '') {
        const list = document.getElementById('os-lista');
        
        if (osList.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tools"></i>
                    <h3>${titulo ? titulo : 'Nenhuma Ordem de Servi√ßo'}</h3>
                    <p>${titulo ? 'Nenhuma OS encontrada com este filtro.' : 'Use o formul√°rio acima para criar uma nova OS.'}</p>
                </div>
            `;
            return;
        }
        
        list.innerHTML = '';
        
        osList.forEach(os => {
            const podeExcluir = this.currentUser && (this.currentUser.role === 'T√âCNICO');
            const podeMudarStatus = this.currentUser && (
                this.currentUser.role === 'T√âCNICO' || 
                (this.currentUser.role === 'OPERADOR' && os.statusOS === 'T√©cnico compareceu ao local')
            );
            
            // üÜï BOT√ïES DE STATUS BASEADOS NO PERFIL
            const botoesStatus = this.gerarBotoesStatusOS(os, podeMudarStatus);
            
            const card = document.createElement('div');
            card.className = 'ata-card os fade-in';
            card.innerHTML = `
                <div class="ata-header">
                    <span><i class="far fa-calendar"></i> ${os.data} | <i class="far fa-clock"></i> ${os.hora}</span>
                    <span class="status-badge status-os" style="background: ${os.corGravidade || '#d6eaf8'};">
                        <i class="fas ${this.getIconeGravidade(os.gravidade)}"></i> ${os.gravidade}
                    </span>
                </div>
                <div class="ata-condo"><i class="fas fa-building"></i> ${os.condo} (${os.cidade})</div>
                <div class="ata-type os">
                    <i class="fas fa-business-time"></i> Prazo: ${os.prazoResposta || '3 dias √∫teis'}
                </div>
                ${os.tecnicoResponsavel ? `
                    <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 6px;
                        border-left: 4px solid #f39c12;">
                        <i class="fas fa-user-cog"></i> <strong>T√©cnico respons√°vel:</strong>
                        ${os.tecnicoResponsavel}
                    </div>
                ` : ''}
                <div style="margin: 10px 0; padding: 8px 15px; background: ${os.corGravidade}20;
                    border-left: 4px solid ${os.corGravidade}; border-radius: 6px;">
                    <strong><i class="fas fa-${this.getIconeGravidade(os.gravidade)}"></i>
                    GRAVIDADE: ${os.gravidade.toUpperCase()}</strong>
                    <div style="font-size: 0.85rem; margin-top: 5px;">
                        <i class="far fa-clock"></i> Prazo m√°ximo: ${os.prazoResposta}
                    </div>
                </div>
                ${os.funcionario ? `
                    <div style="margin: 10px 0; padding: 10px; background: #e8f4fc; border-radius: 6px;
                        border-left: 4px solid #3498db;">
                        <i class="fas fa-user"></i> <strong>Solicitante:</strong>
                        ${os.funcionario} (${os.setor || 'N√£o informado'})<br>
                        <i class="fas fa-envelope"></i> <strong>E-mail:</strong> ${os.email || 'N√£o informado'}
                    </div>
                ` : ''}
                ${os.enviadoPorEmail ? `
                    <div style="margin: 10px 0; padding: 8px 15px; background: #d4edda; border-radius: 6px;
                        border-left: 4px solid #27ae60;">
                        <i class="fas fa-paper-plane"></i> <strong>Enviado por e-mail</strong>
                        <div style="font-size: 0.85rem; margin-top: 5px;">
                            <i class="far fa-clock"></i> ${new Date(os.dataEnvioEmail).toLocaleString('pt-BR')}
                        </div>
                    </div>
                ` : ''}
                <!-- üÜï STATUS DA OS -->
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong><i class="fas fa-flag"></i> Status da OS:</strong>
                        <span class="os-status-badge ${this.getClasseStatusOS(os.statusOS)}">
                            ${this.getIconeStatusOS(os.statusOS)} ${os.statusOS || 'Em branco'}
                        </span>
                    </div>
                    ${os.atualizadoPor ? `
                        <div style="font-size: 0.85rem; color: #666;">
                            <i class="fas fa-user-edit"></i> Atualizado por: ${os.atualizadoPor}
                            ${os.dataAtualizacao ? ` em ${new Date(os.dataAtualizacao).toLocaleString('pt-BR')}` : ''}
                        </div>
                    ` : ''}
                    <!-- üÜï BOT√ïES DE A√á√ÉO -->
                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
                        ${botoesStatus}
                    </div>
                </div>
                <div style="white-space: pre-wrap; margin: 15px 0; padding: 15px; background: #d6eaf820; border-radius: 6px; line-height: 1.5;">
                    ${os.desc}
                </div>
                <div style="font-size: 0.85rem; color: #666; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <i class="fas fa-user-edit"></i> Operador: ${os.operador}
                        ${os.osId ? `<br><i class="fas fa-hashtag"></i> OS: ${os.osId}` : ''}
                    </div>
                    ${podeExcluir ?
                        `<button class="btn btn-danger" onclick="app.excluirOS(${os.id})" title="Apenas t√©cnicos podem excluir">
                            <i class="fas fa-trash"></i> Excluir
                        </button>` :
                        ''
                    }
                </div>
            `;
            
            list.appendChild(card);
        });
    },

    // üÜï FUN√á√ÉO PARA GERAR BOT√ïES DE STATUS
    gerarBotoesStatusOS(os, podeMudarStatus) {
        if (!podeMudarStatus) return '';
        
        const statusOptions = [
            { value: 'Resolvida', label: '‚úÖ Resolvida', class: 'tec-only', icon: 'fa-check-circle' },
            { value: 'T√©cnico resolveu remotamente', label: 'üñ•Ô∏è Remotamente', class: 'tec-only', icon: 'fa-desktop' },
            { value: 'Em espera', label: '‚è≥ Em espera', class: 'tec-only', icon: 'fa-clock' },
            { value: 'T√©cnico compareceu ao local', label: 'üìç Compareceu', class: 'all', icon: 'fa-map-marker-alt' },
            { value: 'Manuten√ß√£o por conta do condom√≠nio - em espera', label: 'üè¢ Condom√≠nio', class: 'tec-only', icon: 'fa-building' },
            { value: 'Em branco', label: 'üìÑ Em branco', class: 'tec-only', icon: 'fa-file' }
        ];
        
        let botoes = '';
        
        statusOptions.forEach(status => {
            // Verificar se o usu√°rio tem permiss√£o
            const podeUsar = status.class === 'all' || 
                           (status.class === 'tec-only' && this.currentUser.role === 'T√âCNICO');
            
            if (podeUsar) {
                const ativo = os.statusOS === status.value ? 'active' : '';
                botoes += `
                    <button class="status-action-btn ${status.class} ${ativo}" 
                            onclick="app.atualizarStatusOS(${os.id}, '${status.value}')"
                            title="${status.value}">
                        <i class="fas ${status.icon}"></i> ${status.label}
                    </button>
                `;
            }
        });
        
        return botoes;
    },

    // üÜï FUN√á√ïES AUXILIARES PARA STATUS
    getClasseStatusOS(status) {
        const classes = {
            'Resolvida': 'os-status-resolvida',
            'T√©cnico resolveu remotamente': 'os-status-remotamente',
            'Em espera': 'os-status-espera',
            'T√©cnico compareceu ao local': 'os-status-compareceu',
            'Manuten√ß√£o por conta do condom√≠nio - em espera': 'os-status-condominio',
            'Em branco': 'os-status-branco'
        };
        return classes[status] || 'os-status-branco';
    },

    getIconeStatusOS(status) {
        const icones = {
            'Resolvida': '‚úÖ',
            'T√©cnico resolveu remotamente': 'üñ•Ô∏è',
            'Em espera': '‚è≥',
            'T√©cnico compareceu ao local': 'üìç',
            'Manuten√ß√£o por conta do condom√≠nio - em espera': 'üè¢',
            'Em branco': 'üìÑ'
        };
        return icones[status] || 'üìÑ';
    },

    renderOS() {
        const osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        this.renderOSList(osList);
    },

    verDetalhesEmailOS(osId) {
        let osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        let historico = JSON.parse(localStorage.getItem('porter_os_emails') || '[]');
        
        const os = osList.find(o => o.id === osId);
        const envio = historico.find(h => h.os_id === osId);
        
        if (!os) return;
        
        const corpoEmail = this.gerarCorpoEmailOS(os);
        const emails = os.emails || [];
        
        const modalContent = `
            <div style="padding: 20px;">
                <h3><i class="fas fa-envelope"></i> E-mail da OS - ${os.condo}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4><i class="fas fa-info-circle"></i> Informa√ß√µes</h4>
                        <p><strong>Destinat√°rios:</strong> ${emails.length}</p>
                        <p><strong>Gravidade:</strong> ${os.gravidade}</p>
                        <p><strong>Data:</strong> ${os.data} ${os.hora}</p>
                        ${envio ? `<p><strong>Registrado em:</strong> ${envio.data}</p>` : ''}
                    </div>
                    <div style="background: #e8f4fc; padding: 15px; border-radius: 8px;">
                        <h4><i class="fas fa-users"></i> Destinat√°rios</h4>
                        <div style="max-height: 100px; overflow-y: auto;">
                            ${emails.map(email => `<div>üìß ${email}</div>`).join('')}
                        </div>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <h4><i class="fas fa-file-alt"></i> Conte√∫do do E-mail</h4>
                    <div style="background: white; border: 1px solid #ddd; padding: 15px;
                        border-radius: 6px; font-family: monospace; white-space: pre-wrap;
                        max-height: 300px; overflow-y: auto; margin-top: 10px;">
                        ${corpoEmail}
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="app.copiarConteudoEmail()">
                        <i class="fas fa-copy"></i> Copiar Conte√∫do
                    </button>
                    <button class="btn btn-success" onclick="app.abrirClienteEmail('${os.condo}', '${emails.join(',')}')">
                        <i class="fas fa-envelope-open"></i> Abrir no Cliente de E-mail
                    </button>
                    <button class="btn btn-clear" onclick="app.fecharModalEmail()">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        
        this.criarModal(`E-mail da OS - ${os.condo}`, modalContent);
    },

    deleteOS(id) {
        let osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
        const os = osList.find(o => o.id === id);
        
        if (!os) {
            alert('Ordem de Servi√ßo n√£o encontrada.');
            return;
        }
        
        const ehAutor = os.user === this.currentUser.user;
        const ehAdmin = this.currentUser.role === 'ADMIN';
        const ehTecnico = this.currentUser.role === 'T√âCNICO';
        
        if (!ehAdmin && !ehAutor && !ehTecnico) {
            alert('Apenas o autor, t√©cnicos ou administradores podem excluir esta Ordem de Servi√ßo.');
            return;
        }
        
        if (confirm('Tem certeza que deseja excluir esta Ordem de Servi√ßo?')) {
            osList = osList.filter(os => os.id !== id);
            localStorage.setItem('porter_os', JSON.stringify(osList));
            this.renderOS();
            this.showMessage('Ordem de Servi√ßo exclu√≠da!', 'success');
        }
    },

    deleteAta(id) {
        let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        const ata = atas.find(a => a.id === id);
        
        if (!ata) {
            alert('Registro n√£o encontrado.');
            return;
        }
        
        const ehAutor = ata.user === this.currentUser.user;
        const ehAdmin = this.currentUser.role === 'ADMIN';
        const ehTecnico = this.currentUser.role === 'T√âCNICO';
        
        if (!ehAdmin && !ehAutor && !ehTecnico) {
            alert('Apenas o autor, t√©cnicos ou administradores podem excluir este registro.');
            return;
        }
        
        if (confirm('Tem certeza que deseja excluir este registro permanentemente?')) {
            let remocoes = JSON.parse(localStorage.getItem('porter_remocoes') || '[]');
            remocoes.unshift({
                id: Date.now(),
                tipo: ata.fixa ? 'Ata Fixa' : 'Ata',
                dados: ata,
                removidoPor: this.currentUser.nome,
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('porter_remocoes', JSON.stringify(remocoes));
            
            atas = atas.filter(a => a.id !== id);
            localStorage.setItem('porter_atas', JSON.stringify(atas));
            
            this.renderAll();
            this.showMessage('Registro exclu√≠do com sucesso!', 'success');
        }
    },

    openReportModal() {
        document.getElementById('report-modal').classList.add('show');
    },

    closeReportModal() {
        document.getElementById('report-modal').classList.remove('show');
    },

    generatePDF() {
        const condo = document.getElementById('report-condo').value;
        const dataInicio = document.getElementById('report-data-inicio').value;
        const dataFim = document.getElementById('report-data-fim').value;
        const tipo = document.getElementById('report-tipo').value;
        
        let dados = [];
        let titulo = '';
        
        if (tipo === 'atas' || tipo === 'all') {
            let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
            if (condo) atas = atas.filter(a => a.condo === condo);
            if (dataInicio) atas = atas.filter(a => a.dataISO >= dataInicio);
            if (dataFim) atas = atas.filter(a => a.dataISO <= dataFim);
            
            if (tipo === 'atas') {
                dados = atas;
                titulo = 'Relat√≥rio de Ocorr√™ncias';
            } else {
                dados = dados.concat(atas.map(a => ({...a, tipoRegistro: 'Ocorr√™ncia'})));
            }
        }
        
        if (tipo === 'fixas' || tipo === 'all') {
            let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
            let fixas = atas.filter(a => a.fixa);
            if (condo) fixas = fixas.filter(a => a.condo === condo);
            if (dataInicio) fixas = fixas.filter(a => a.dataISO >= dataInicio);
            if (dataFim) fixas = fixas.filter(a => a.dataISO <= dataFim);
            
            if (tipo === 'fixas') {
                dados = fixas;
                titulo = 'Relat√≥rio de Informa√ß√µes Fixas';
            } else {
                dados = dados.concat(fixas.map(a => ({...a, tipoRegistro: 'Informa√ß√£o Fixa'})));
            }
        }
        
        if (tipo === 'os' || tipo === 'all') {
            let osList = JSON.parse(localStorage.getItem('porter_os') || '[]');
            if (condo) osList = osList.filter(os => os.condo === condo);
            if (dataInicio) osList = osList.filter(os => os.dataISO >= dataInicio);
            if (dataFim) osList = osList.filter(os => os.dataISO <= dataFim);
            
            if (tipo === 'os') {
                dados = osList;
                titulo = 'Relat√≥rio de Ordens de Servi√ßo';
            } else {
                dados = dados.concat(osList.map(os => ({...os, tipoRegistro: 'Ordem de Servi√ßo'})));
            }
        }
        
        if (tipo === 'all') {
            titulo = 'Relat√≥rio Completo';
        }
        
        if (dados.length === 0) {
            alert('Nenhum registro encontrado para os filtros selecionados.');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabe√ßalho
        doc.setFillColor(26, 58, 95);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text('PORTER', 105, 15, { align: 'center' });
        doc.setFontSize(12);
        doc.text('Ata Operacional - 2026', 105, 22, { align: 'center' });
        
        // T√≠tulo do relat√≥rio
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(16);
        doc.text(titulo, 105, 40, { align: 'center' });
        
        // Filtros aplicados
        doc.setFontSize(10);
        let filtrosTexto = `Condom√≠nio: ${condo || 'Todos'} | Per√≠odo: ${dataInicio || 'In√≠cio'} a ${dataFim || 'Fim'}`;
        doc.text(filtrosTexto, 105, 50, { align: 'center' });
        
        // Data de gera√ß√£o
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 105, 55, { align: 'center' });
        
        // Conte√∫do
        let y = 70;
        
        dados.forEach((item, index) => {
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`${index + 1}. ${item.condo || ''}`, 10, y);
            doc.setFont(undefined, 'normal');
            y += 7;
            
            doc.setFontSize(10);
            doc.text(`Data: ${item.data} ${item.hora} | Tipo: ${item.tipoRegistro || item.tipo || ''}`, 10, y);
            y += 5;
            
            if (item.gravidade) {
                doc.text(`Gravidade: ${item.gravidade} | Prazo: ${item.prazoResposta || ''}`, 10, y);
                y += 5;
            }
            
            if (item.statusOS) {
                doc.text(`Status: ${item.statusOS}`, 10, y);
                y += 5;
            }
            
            doc.text(`Operador: ${item.operador} | Status: ${item.status || ''}`, 10, y);
            y += 5;
            
            const desc = item.desc || '';
            const descLines = doc.splitTextToSize(desc, 190);
            
            doc.text('Descri√ß√£o:', 10, y);
            y += 5;
            
            descLines.forEach(line => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, 15, y);
                y += 5;
            });
            
            y += 10;
            
            if (index < dados.length - 1) {
                doc.setDrawColor(200, 200, 200);
                doc.line(10, y, 200, y);
                y += 5;
            }
        });
        
        // Rodap√©
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Total de registros: ${dados.length}`, 105, 285, { align: 'center' });
        doc.text('Porter - Ata Operacional 2026', 105, 290, { align: 'center' });
        
        doc.save(`relatorio-porter-${new Date().toISOString().slice(0, 10)}.pdf`);
        this.closeReportModal();
        this.showMessage('Relat√≥rio gerado com sucesso!', 'success');
    },

    renderAll() {
        this.renderAta();
        this.renderFixas();
        this.renderOS();
        this.renderPresenca();
    },

    renderAta() {
        const list = document.getElementById('ata-lista');
        const info = document.getElementById('resultados-info-ata');
        
        let atas = JSON.parse(localStorage.getItem('porter_atas') || '[]');
        atas = atas.filter(a => !a.fixa);
        
        if (this.filtrosAtas.condo) {
            atas = atas.filter(a => a.condo === this.filtrosAtas.condo);
        }
        
        if (this.filtrosAtas.dataInicio) {
            atas = atas.filter(a => a.dataISO >= this.filtrosAtas.dataInicio);
        }
        
        if (this.filtrosAtas.dataFim) {
            atas = atas.filter(a => a.dataISO <= this.filtrosAtas.dataFim);
        }
        
        if (this.filtrosAtas.tipo) {
            atas = atas.filter(a => a.tipo === this.filtrosAtas.tipo);
        }
        
        if (this.filtrosAtas.status) {
            atas = atas.filter(a => a.status === this.filtrosAtas.status);
        }
        
        const totalAtas = JSON.parse(localStorage.getItem('porter_atas') || '[]').filter(a => !a.fixa).length;
        
        info.innerHTML = `
            <div class="active-filters">
                <i class="fas fa-chart-bar"></i>
                Mostrando ${atas.length} de ${totalAtas} registros
                ${this.filtrosAtas.condo ? `<span>Condom√≠nio: ${this.filtrosAtas.condo}</span>` : ''}
                ${this.filtrosAtas.dataInicio || this.filtrosAtas.dataFim ? `<span>Per√≠odo: ${this.formatarDataBR(this.filtrosAtas.dataInicio)} a ${this.formatarDataBR(this.filtrosAtas.dataFim)}</span>` : ''}
                ${this.filtrosAtas.tipo ? `<span>Tipo: ${this.filtrosAtas.tipo}</span>` : ''}
                ${this.filtrosAtas.status ? `<span>Status: ${this.filtrosAtas.status}</span>` : ''}
            </div>
        `;
        
        if (atas.length === 0) {
            list.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h3>Nenhum registro encontrado</h3>
                    <p>${totalAtas === 0 ? 'Comece criando seu primeiro registro.' : 'Nenhum registro corresponde aos filtros aplicados.'}</p>
                </div>
            `;
            return;
        }
        
        list.innerHTML = '';
        
        atas.forEach(a => {
            const podeExcluir = this.currentUser && (this.currentUser.role === 'ADMIN' || a.user === this.currentUser.user || this.currentUser.role === 'T√âCNICO');
            
            const card = document.createElement('div');
            card.className = 'ata-card fade-in';
            card.innerHTML = `
                <div class="ata-header">
                    <span><i class="far fa-calendar"></i> ${a.data} | <i class="far fa-clock"></i> ${a.hora} | <i class="fas fa-user-clock"></i> Turno: ${a.turno}</span>
                    <span class="status-badge ${a.status === 'Finalizado' ? 'status-finalizado' : 'status-andamento'}">
                        <i class="fas fa-${a.status === 'Finalizado' ? 'check-circle' : 'sync-alt'}"></i> ${a.status}
                    </span>
                </div>
                <div class="ata-condo"><i class="fas fa-building"></i> ${a.condo} (${a.cidade})</div>
                <div class="ata-type"><i class="fas fa-tag"></i> ${a.tipo}</div>
                <div style="white-space: pre-wrap; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; line-height: 1.5;">
                    ${a.desc}
                </div>
                <div style="font-size: 0.85rem; color: #666; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <i class="fas fa-user-edit"></i> Operador: ${a.operador}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="app.abrirComentarios(${a.id})">
                            <i class="fas fa-comments"></i> Coment√°rios (${a.comentarios ? a.comentarios.length : 0})
                        </button>
                        ${podeExcluir ?
                            `<button class="btn btn-danger" onclick="app.deleteAta(${a.id})" title="Apenas autor, t√©cnico ou admin pode excluir">
                                <i class="fas fa-trash"></i> Excluir
                            </button>` :
                            ''
                        }
                    </div>
                </div>
            `;
            
            list.appendChild(card);
        });
        
        this.mostrarFiltrosAtivosAtas();
    },

    // FIX: HIST√ìRICO DE LOGIN/LOGOFF - MOSTRAR JUNTOS
    renderPresenca() {
        const list = document.getElementById('presenca-lista');
        let presencas = JSON.parse(localStorage.getItem('porter_presencas') || '[]');
        let logoffs = JSON.parse(localStorage.getItem('porter_logoffs') || '[]');
        
        // Combinar logins e logoffs
        let historicoCombinado = [];
        
        presencas.forEach(login => {
            const loginDate = login.dataISO || login.data;
            const loginTime = new Date(login.timestamp).getTime();
            
            // Procurar logoff correspondente
            const logoffCorrespondente = logoffs.find(logoff => 
                logoff.user === login.user && 
                (logoff.dataISO || logoff.data) === loginDate &&
                new Date(logoff.timestamp).getTime() > loginTime
            );
            
            historicoCombinado.push({
                nome: login.nome,
                turno: login.turno,
                data: login.data,
                horaLogin: login.hora,
                horaLogoff: logoffCorrespondente ? logoffCorrespondente.hora : '‚Äî',
                timestampLogin: login.timestamp,
                timestampLogoff: logoffCorrespondente ? logoffCorrespondente.timestamp : null
            });
        });
        
        // Adicionar logoffs sem login correspondente (se houver)
        logoffs.forEach(logoff => {
            const jaExiste = historicoCombinado.some(item => 
                item.nome === logoff.nome && 
                item.data === logoff.data &&
                item.horaLogoff === logoff.hora
            );
            
            if (!jaExiste) {
                historicoCombinado.push({
                    nome: logoff.nome,
                    turno: logoff.turno || '‚Äî',
                    data: logoff.data,
                    horaLogin: '‚Äî',
                    horaLogoff: logoff.hora,
                    timestampLogin: null,
                    timestampLogoff: logoff.timestamp
                });
            }
        });
        
        historicoCombinado.sort((a, b) => {
            const timeA = a.timestampLogoff || a.timestampLogin || 0;
            const timeB = b.timestampLogoff || b.timestampLogin || 0;
            return new Date(timeB) - new Date(timeA);
        });
        
        // Aplicar filtros
        if (this.filtrosPresenca.operador) {
            historicoCombinado = historicoCombinado.filter(p => p.nome === this.filtrosPresenca.operador);
        }
        
        if (this.filtrosPresenca.dataInicio) {
            historicoCombinado = historicoCombinado.filter(p => p.data >= this.filtrosPresenca.dataInicio);
        }
        
        if (this.filtrosPresenca.dataFim) {
            historicoCombinado = historicoCombinado.filter(p => p.data <= this.filtrosPresenca.dataFim);
        }
        
        if (this.filtrosPresenca.turno) {
            historicoCombinado = historicoCombinado.filter(p => p.turno === this.filtrosPresenca.turno);
        }
        
        historicoCombinado = historicoCombinado.slice(0, 100);
        
        if (historicoCombinado.length === 0) {
            list.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 3rem; color: #888;">
                        <i class="fas fa-history" style="font-size: 2rem; display: block; margin-bottom: 1rem; color: #ddd;"></i>
                        Nenhum registro de hist√≥rico encontrado
                    </td>
                </tr>
            `;
            return;
        }
        
        list.innerHTML = historicoCombinado.map(p => `
            <tr>
                <td><i class="fas fa-user-circle"></i> ${p.nome}</td>
                <td><span style="padding: 4px 10px; background: ${p.turno === 'Diurno' ? '#fff3cd' : '#e8f4fc'}; border-radius: 4px;">${p.turno}</span></td>
                <td>${p.data}</td>
                <td><i class="fas fa-sign-in-alt" style="color: #27ae60;"></i> ${p.horaLogin}</td>
                <td><i class="fas fa-sign-out-alt" style="color: #e74c3c;"></i> ${p.horaLogoff}</td>
            </tr>
        `).join('');
    },

    // FIX: CHAT - REMOVER AUTO-SCROLL FOR√áADO
    loadChat() {
        const container = document.getElementById('chat-messages');
        const chat = JSON.parse(localStorage.getItem('porter_chat') || '[]');
        
        if (this.currentUser && (this.currentUser.role === 'ADMIN' || this.currentUser.role === 'T√âCNICO')) {
            document.getElementById('chat-admin-controls').style.display = 'flex';
        }
        
        if (chat.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gray);">
                    <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Nenhuma mensagem ainda. Seja o primeiro a enviar uma mensagem!</p>
                </div>
            `;
            this.mostrarVistoPor(container);
            return;
        }
        
        const chatOrdenado = [...chat].reverse();
        const scrollPosAntes = container.scrollTop;
        const alturaAntes = container.scrollHeight;
        
        container.innerHTML = '';
        
        chatOrdenado.forEach(msg => {
            const isSent = msg.sender === this.currentUser.nome;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isSent ? 'sent' : 'received'}`;
            messageDiv.dataset.id = msg.id;
            
            messageDiv.innerHTML = `
                <div class="chat-message-header">
                    <span class="chat-message-sender">
                        <span style="font-size: 1.1rem; margin-right: 5px;">${msg.senderMood || 'üòê'}</span>
                        ${msg.sender} ${msg.senderRole === 'ADMIN' ? ' üëë' : ''} ${msg.senderRole === 'T√âCNICO' ? ' üîß' : ''}
                    </span>
                    <span class="chat-message-time">${msg.date} ${msg.time}</span>
                </div>
                <div class="chat-message-text">${msg.message}</div>
                ${this.currentUser && (this.currentUser.role === 'ADMIN' || this.currentUser.role === 'T√âCNICO') && !isSent ?
                    `<div style="margin-top: 5px; text-align: right;">
                        <button class="btn btn-danger btn-sm" onclick="app.deleteChatMessage(${msg.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>` :
                    ''
                }
            `;
            
            container.appendChild(messageDiv);
        });
        
        this.mostrarVistoPor(container);
        
        // Manter posi√ß√£o do scroll apenas se estava no final
        const alturaDepois = container.scrollHeight;
        const estavaNoFinal = Math.abs((scrollPosAntes + container.clientHeight) - alturaAntes) < 50;
        
        if (estavaNoFinal) {
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        } else {
            // Manter posi√ß√£o relativa
            const proporcao = scrollPosAntes / (alturaAntes - container.clientHeight);
            container.scrollTop = proporcao * (alturaDepois - container.clientHeight);
        }
        
        this.registrarVisualizacaoChat();
        this.atualizarBadgeChat();
    },

    mostrarVistoPor(container) {
        const vistoPorDiv = document.createElement('div');
        vistoPorDiv.className = 'chat-visto-por';
        vistoPorDiv.style.cssText = `
            margin-top: 20px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            border-top: 1px solid #e0e0e0;
            animation: fadeIn 0.5s ease-out;
        `;
        
        const visualizacoes = this.obterVisualizacoesRecentes();
        
        if (visualizacoes.length > 0) {
            visualizacoes.sort((a, b) => b.timestamp - a.timestamp);
            const usuarios = visualizacoes.map(v => 
                `${v.nome.split(' ')[0]} ${v.mood}`
            ).join(', ');
            
            const ultimaVisualizacao = visualizacoes[0];
            const tempoUltima = this.formatarTempoAtivo(new Date(ultimaVisualizacao.timestamp));
            
            vistoPorDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 5px;">
                    <i class="fas fa-eye" style="color: #3498db;"></i>
                    <strong style="color: #1a3a5f;">Visto por:</strong>
                    <span>${usuarios}</span>
                </div>
                <div style="font-size: 0.75rem; color: #888;">
                    <i class="far fa-clock"></i> √öltima visualiza√ß√£o: ${tempoUltima}
                </div>
            `;
        } else {
            vistoPorDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-eye-slash" style="color: #999;"></i>
                    <span style="color: #999;">Ningu√©m viu o chat recentemente</span>
                </div>
            `;
        }
        
        container.appendChild(vistoPorDiv);
    },

    destacarMensagemChat(mensagemId) {
        const mensagens = document.querySelectorAll('.chat-message');
        mensagens.forEach(msg => {
            msg.classList.remove('mensagem-destacada');
            if (msg.dataset.id === String(mensagemId)) {
                msg.classList.add('mensagem-destacada');
                msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    msg.classList.remove('mensagem-destacada');
                }, 5000);
            }
        });
    },

    deleteChatMessage(id) {
        if (this.currentUser.role !== 'ADMIN' && this.currentUser.role !== 'T√âCNICO') {
            alert('Apenas administradores ou t√©cnicos podem excluir mensagens.');
            return;
        }
        
        if (confirm('Tem certeza que deseja excluir esta mensagem?')) {
            let chat = JSON.parse(localStorage.getItem('porter_chat') || '[]');
            chat = chat.filter(msg => msg.id !== id);
            localStorage.setItem('porter_chat', JSON.stringify(chat));
            this.loadChat();
            this.updateTabCounts();
        }
    },

    clearChat() {
        if (this.currentUser.role !== 'ADMIN' && this.currentUser.role !== 'T√âCNICO') {
            alert('Apenas administradores ou t√©cnicos podem limpar o chat.');
            return;
        }
        
        if (confirm('Tem certeza que deseja limpar todas as mensagens do chat?')) {
            localStorage.removeItem('porter_chat');
            this.loadChat();
            this.updateTabCounts();
            this.showMessage('Chat limpo com sucesso!', 'success');
        }
    },

    // FIX: CHAT PRIVADO - REMOVER AUTO-SCROLL FOR√áADO
    loadPrivateChatUsers() {
        if (!this.currentUser) return;
        
        const select = document.getElementById('private-chat-target');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione um operador...</option>';
        
        // Filtrar para n√£o incluir o usu√°rio atual
        const outrosOperadores = DATA.funcionarios.filter(f => 
            f.user !== this.currentUser.user
        );
        
        outrosOperadores.forEach(op => {
            const option = document.createElement('option');
            option.value = op.user;
            option.textContent = `${op.nome} (${op.role})`;
            select.appendChild(option);
        });
        
        // üÜï ADICIONAR T√âCNICOS √Ä LISTA
        DATA.tecnicos.forEach(tec => {
            const tecUser = tec.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.');
            if (tecUser !== this.currentUser.user) {
                const option = document.createElement('option');
                option.value = tecUser;
                option.textContent = `${tec.nome} (T√âCNICO)`;
                select.appendChild(option);
            }
        });
    },

    // FIX: CHAT PRIVADO - REMOVER AUTO-SCROLL FOR√áADO
    loadPrivateChat() {
        if (!this.currentUser || !this.currentPrivateChatTarget) return;
        
        const container = document.getElementById('chat-private-messages');
        const privateChats = JSON.parse(localStorage.getItem('porter_chat_privado') || '{}');
        
        // Gerar ID da conversa (ordem alfab√©tica para garantir consist√™ncia)
        const chatId = this.getPrivateChatId(this.currentUser.user, this.currentPrivateChatTarget);
        const messages = privateChats[chatId] || [];
        
        // Ativar/desativar campo de entrada
        const input = document.getElementById('chat-private-input');
        const sendBtn = document.getElementById('chat-private-send-btn');
        
        if (this.currentPrivateChatTarget) {
            input.disabled = false;
            sendBtn.disabled = false;
        } else {
            input.disabled = true;
            sendBtn.disabled = true;
        }
        
        if (messages.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gray);">
                    <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Nenhuma mensagem ainda. Comece a conversa!</p>
                </div>
            `;
            return;
        }
        
        const messagesOrdenado = [...messages].reverse();
        const scrollPosAntes = container.scrollTop;
        const alturaAntes = container.scrollHeight;
        
        container.innerHTML = '';
        
        messagesOrdenado.forEach(msg => {
            const isSent = msg.sender === this.currentUser.user;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isSent ? 'sent' : 'received'}`;
            messageDiv.dataset.id = msg.id;
            
            // Obter nome do remetente
            const senderInfo = DATA.funcionarios.find(f => f.user === msg.sender) || 
                              DATA.tecnicos.find(t => t.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.') === msg.sender) ||
                              { nome: msg.sender, role: 'OPERADOR' };
            
            messageDiv.innerHTML = `
                <div class="chat-message-header">
                    <span class="chat-message-sender">
                        <span style="font-size: 1.1rem; margin-right: 5px;">${msg.senderMood || 'üòê'}</span>
                        ${senderInfo.nome.split(' ')[0]} ${senderInfo.role === 'ADMIN' ? ' üëë' : ''} ${senderInfo.role === 'T√âCNICO' ? ' üîß' : ''}
                    </span>
                    <span class="chat-message-time">${msg.date} ${msg.time}</span>
                </div>
                <div class="chat-message-text">${msg.message}</div>
            `;
            
            container.appendChild(messageDiv);
        });
        
        // Manter posi√ß√£o do scroll apenas se estava no final
        const alturaDepois = container.scrollHeight;
        const estavaNoFinal = Math.abs((scrollPosAntes + container.clientHeight) - alturaAntes) < 50;
        
        if (estavaNoFinal) {
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        } else {
            // Manter posi√ß√£o relativa
            const proporcao = scrollPosAntes / (alturaAntes - container.clientHeight);
            container.scrollTop = proporcao * (alturaDepois - container.clientHeight);
        }
        
        // Marcar como visualizado
        this.marcarChatPrivadoComoVisualizado(chatId);
    },

    getPrivateChatId(user1, user2) {
        // Ordenar os usu√°rios para garantir ID consistente
        const users = [user1, user2].sort();
        return `${users[0]}_${users[1]}`;
    },

    // FIX: CHAT PRIVADO - ENVIO SEM FOR√áAR SCROLL
    sendPrivateChatMessage() {
        if (!this.currentUser || !this.currentPrivateChatTarget) {
            alert('Selecione um destinat√°rio primeiro.');
            return;
        }
        
        const input = document.getElementById('chat-private-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        const sendBtn = document.getElementById('chat-private-send-btn');
        const originalHTML = sendBtn.innerHTML;
        sendBtn.innerHTML = '<div class="loading"></div>';
        sendBtn.disabled = true;
        
        // Gerar ID da conversa
        const chatId = this.getPrivateChatId(this.currentUser.user, this.currentPrivateChatTarget);
        
        const chatMessage = {
            id: Date.now(),
            sender: this.currentUser.user,
            senderName: this.currentUser.nome,
            senderRole: this.currentUser.role,
            senderMood: this.getMoodAtual(),
            receiver: this.currentPrivateChatTarget,
            message: message,
            time: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString('pt-BR')
        };
        
        // Carregar conversas existentes
        let privateChats = JSON.parse(localStorage.getItem('porter_chat_privado') || '{}');
        
        // Inicializar array se n√£o existir
        if (!privateChats[chatId]) {
            privateChats[chatId] = [];
        }
        
        // Adicionar mensagem
        privateChats[chatId].push(chatMessage);
        
        // Limitar hist√≥rico (√∫ltimas 100 mensagens por conversa)
        if (privateChats[chatId].length > 100) {
            privateChats[chatId] = privateChats[chatId].slice(-100);
        }
        
        // Salvar
        localStorage.setItem('porter_chat_privado', JSON.stringify(privateChats));
        
        // Limpar campo de entrada
        input.value = '';
        
        // Restaurar bot√£o
        setTimeout(() => {
            sendBtn.innerHTML = originalHTML;
            sendBtn.disabled = false;
            input.focus();
        }, 500);
        
        // Recarregar chat
        this.loadPrivateChat();
        
        // Atualizar badge
        this.atualizarBadgeChatPrivado();
        
        // Criar notifica√ß√£o para o destinat√°rio
        this.criarNotificacaoChatPrivado(chatMessage);
    },

    criarNotificacaoChatPrivado(chatMessage) {
        // Obter informa√ß√µes do destinat√°rio
        let destinatario = DATA.funcionarios.find(f => f.user === chatMessage.receiver);
        if (!destinatario) {
            // Verificar se √© um t√©cnico
            destinatario = DATA.tecnicos.find(t => 
                t.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.') === chatMessage.receiver
            );
        }
        
        if (!destinatario) return;
        
        const notificacao = {
            id: Date.now(),
            condo: 'Chat Privado',
            tipo: 'chat_privado',
            desc: `Nova mensagem privada de ${chatMessage.senderName.split(' ')[0]}: ${chatMessage.message.substring(0, 50)}${chatMessage.message.length > 50 ? '...' : ''}`,
            data: new Date().toLocaleDateString('pt-BR'),
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
            timestamp: new Date().toISOString(),
            lida: false,
            acao: {
                tipo: 'ir_para_chat_privado',
                sender: chatMessage.sender,
                receiver: chatMessage.receiver
            },
            destaque: true
        };
        
        let notificacoes = JSON.parse(localStorage.getItem('porter_notificacoes') || '[]');
        notificacoes.unshift(notificacao);
        
        if (notificacoes.length > 50) notificacoes.pop();
        localStorage.setItem('porter_notificacoes', JSON.stringify(notificacoes));
        
        this.loadNotifications();
        this.updateNotificationBadges();
        this.atualizarBadgeChatPrivado();
    },

    marcarChatPrivadoComoVisualizado(chatId) {
        localStorage.setItem(`porter_chat_privado_last_view_${chatId}`, Date.now().toString());
        this.atualizarBadgeChatPrivado();
    },

    openAdminPanel() {
        const modalContent = document.getElementById('admin-modal-content');
        const sessions = JSON.parse(localStorage.getItem('porter_last_session') ? 
            [JSON.parse(localStorage.getItem('porter_last_session'))] : []);
        
        const operadoresLogados = DATA.funcionarios.filter(f => 
            sessions.some(s => s.user === f.user &&
                (new Date() - new Date(s.lastActivity)) < 300000));
        
        // üÜï ADICIONAR T√âCNICOS LOGADOS
        const tecnicosLogados = DATA.tecnicos.filter(t => {
            const tecUser = t.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.');
            return sessions.some(s => s.user === tecUser &&
                (new Date() - new Date(s.lastActivity)) < 300000);
        });
        
        const todosLogados = [...operadoresLogados, ...tecnicosLogados.map(t => ({
            nome: t.nome,
            user: t.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.'),
            role: 'T√âCNICO'
        }))];
        
        modalContent.innerHTML = `
            <h4><i class="fas fa-users"></i> Operadores Logados</h4>
            <div style="margin: 1rem 0; max-height: 200px; overflow-y: auto;">
                ${todosLogados.length > 0 ?
                    todosLogados.map(op => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${op.nome}</strong>
                                <div style="font-size: 0.8rem; color: #666;">${op.role} ${op.role === 'T√âCNICO' ? 'üîß' : ''}</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="app.forceLogoff('${op.user}')">
                                <i class="fas fa-sign-out-alt"></i> Deslogar
                            </button>
                        </div>
                    `).join('') :
                    '<p style="text-align: center; color: #888; padding: 2rem;">Nenhum operador logado</p>'
                }
            </div>
            <h4 style="margin-top: 2rem;"><i class="fas fa-history"></i> Hist√≥rico de Remo√ß√µes</h4>
            <div style="margin: 1rem 0; max-height: 200px; overflow-y: auto;">
                ${this.renderHistoricoRemocoes()}
            </div>
            <!-- üÜï HIST√ìRICO DE EXCLUS√ïES DE OS -->
            <h4 style="margin-top: 2rem;"><i class="fas fa-trash"></i> Hist√≥rico de Exclus√µes de OS</h4>
            <div style="margin: 1rem 0; max-height: 200px; overflow-y: auto;">
                ${this.renderHistoricoExclusoesOS()}
            </div>
            <h4 style="margin-top: 2rem;"><i class="fas fa-envelope"></i> Hist√≥rico de Envios de E-mail</h4>
            <div style="margin: 1rem 0; max-height: 200px; overflow-y: auto;">
                ${this.renderHistoricoEmails()}
            </div>
            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee;">
                <button class="btn btn-warning" onclick="app.exportBackup()">
                    <i class="fas fa-download"></i> Exportar Backup
                </button>
                <button class="btn btn-danger" onclick="app.clearAllData()" style="margin-left: 10px;">
                    <i class="fas fa-trash"></i> Limpar Todos os Dados
                </button>
            </div>
        `;
        
        document.getElementById('admin-modal').classList.add('show');
    },

    // üÜï FUN√á√ÉO PARA RENDERIZAR HIST√ìRICO DE EXCLUS√ïES DE OS
    renderHistoricoExclusoesOS() {
        const exclusoes = JSON.parse(localStorage.getItem('porter_exclusoes_os') || '[]');
        
        if (exclusoes.length === 0) {
            return '<p style="text-align: center; color: #888; padding: 1rem;">Nenhuma exclus√£o de OS registrada</p>';
        }
        
        return exclusoes.slice(0, 10).map(e => `
            <div style="padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; background: #f8d7da;">
                <div><strong>OS ${e.osId}</strong> - ${e.condo || 'N/A'}</div>
                <div style="color: #666;">Exclu√≠do por: ${e.excluidoPor} | ${e.data} ${e.hora}</div>
            </div>
        `).join('');
    },

    closeAdminModal() {
        document.getElementById('admin-modal').classList.remove('show');
    },

    renderHistoricoRemocoes() {
        const remocoes = JSON.parse(localStorage.getItem('porter_remocoes') || '[]');
        
        if (remocoes.length === 0) {
            return '<p style="text-align: center; color: #888; padding: 1rem;">Nenhuma remo√ß√£o registrada</p>';
        }
        
        return remocoes.slice(0, 10).map(r => `
            <div style="padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem;">
                <div><strong>${r.tipo}</strong> - ${r.dados.condo || 'N/A'}</div>
                <div style="color: #666;">Removido por: ${r.removidoPor} | ${r.data} ${r.hora}</div>
            </div>
        `).join('');
    },

    renderHistoricoEmails() {
        const historico = JSON.parse(localStorage.getItem('porter_os_emails') || '[]');
        
        if (historico.length === 0) {
            return '<p style="text-align: center; color: #888; padding: 1rem;">Nenhum envio de e-mail registrado</p>';
        }
        
        return historico.slice(0, 10).map(r => `
            <div style="padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem;
                background: ${r.sucesso ? '#d4edda' : '#f8d7da'}">
                <div>
                    <strong>${r.condo}</strong> - ${r.gravidade}
                    <span style="float: right; color: ${r.sucesso ? '#155724' : '#721c24'}">
                        <i class="fas fa-${r.sucesso ? 'check-circle' : 'times-circle'}"></i>
                    </span>
                </div>
                <div style="color: #666;">
                    ${r.destinatarios.length} destinat√°rio(s) | ${r.data}
                </div>
                ${r.erro ? `<div style="color: #dc3545; font-size: 0.8em;">Erro: ${r.erro}</div>` : ''}
            </div>
        `).join('');
    },

    forceLogoff(user) {
        if (confirm(`Tem certeza que deseja deslogar este usu√°rio?`)) {
            let usuario = DATA.funcionarios.find(f => f.user === user);
            if (!usuario) {
                // Verificar se √© um t√©cnico
                usuario = DATA.tecnicos.find(t => 
                    t.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.') === user
                );
                if (usuario) {
                    usuario = {
                        nome: usuario.nome,
                        user: usuario.nome.split(' - ')[0].toLowerCase().replace(/\s+/g, '.'),
                        role: 'T√âCNICO'
                    };
                }
            }
            
            if (usuario) {
                const logoffs = JSON.parse(localStorage.getItem('porter_logoffs') || '[]');
                logoffs.unshift({
                    user: usuario.user,
                    nome: usuario.nome,
                    data: new Date().toLocaleDateString('pt-BR'),
                    hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                    timestamp: new Date().toISOString(),
                    turno: 'For√ßado',
                    for√ßado: true,
                    por: this.currentUser.nome
                });
                localStorage.setItem('porter_logoffs', JSON.stringify(logoffs));
            }
            
            localStorage.removeItem('porter_last_session');
            this.showMessage('Usu√°rio deslogado com sucesso!', 'success');
            this.openAdminPanel();
        }
    },

    exportBackup() {
        const backup = {
            atas: JSON.parse(localStorage.getItem('porter_atas') || '[]'),
            os: JSON.parse(localStorage.getItem('porter_os') || '[]'),
            presencas: JSON.parse(localStorage.getItem('porter_presencas') || '[]'),
            logoffs: JSON.parse(localStorage.getItem('porter_logoffs') || '[]'),
            moods: JSON.parse(localStorage.getItem('porter_moods') || '[]'),
            notificacoes: JSON.parse(localStorage.getItem('porter_notificacoes') || '[]'),
            chat: JSON.parse(localStorage.getItem('porter_chat') || '[]'),
            chat_privado: JSON.parse(localStorage.getItem('porter_chat_privado') || '{}'),
            remocoes: JSON.parse(localStorage.getItem('porter_remocoes') || '[]'),
            os_emails: JSON.parse(localStorage.getItem('porter_os_emails') || '[]'),
            exclusoes_os: JSON.parse(localStorage.getItem('porter_exclusoes_os') || '[]'),
            exportDate: new Date().toISOString(),
            exportBy: this.currentUser.nome
        };
        
        const dataStr = JSON.stringify(backup, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `backup-porter-${new Date().toISOString().slice(0, 10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        this.showMessage('Backup exportado com sucesso!', 'success');
    },

    clearAllData() {
        if (confirm('ATEN√á√ÉO: Esta a√ß√£o ir√° APAGAR TODOS os dados do sistema. Tem certeza?')) {
            const dadosParaManter = {
                condominios: DATA.condominios,
                funcionarios: DATA.funcionarios,
                tecnicos: DATA.tecnicos
            };
            
            localStorage.clear();
            
            localStorage.setItem('porter_condominios', JSON.stringify(dadosParaManter.condominios));
            localStorage.setItem('porter_funcionarios', JSON.stringify(dadosParaManter.funcionarios));
            localStorage.setItem('porter_tecnicos', JSON.stringify(dadosParaManter.tecnicos));
            
            location.reload();
        }
    },

    showMessage(text, type) {
        const message = document.createElement('div');
        message.innerHTML = `
            <div style="
                position: fixed; top: 20px; right: 20px;
                padding: 1rem 1.5rem; border-radius: 8px;
                background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
                color: white; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex; align-items: center; gap: 10px; animation: fadeIn 0.3s;
            ">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${text}
            </div>
        `;
        
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.remove();
        }, 3000);
    }
};

// Inicializar o sistema
window.onload = () => app.init();
</script>
</body>
</html>

